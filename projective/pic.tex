%% The goal of this note is to show that $\Pic(\bP^n) = \Z$ in the setting of Synthetic Algebraic
%% Geometry \cite{draft}. We actually present a strengthening of this result,
%% which in particular states the equivalence
%% $$(\bP^1\to{\KR})\simeq (\Z\times \KR)$$
%% %We will also present Matthias' strengthened version of this statement, which states that the
%% %map $\Z\times \KR\rightarrow {\KR}^{\bP^1},~p,l\mapsto (x\mapsto l\times \OO(p)(x))$
%% %is an equivalence.

%% One application is that $\Aut(\bP^n)$ is $\PGL_{n+1}$.

%% For the case $n=1$,
%% we follow the proof of Horrock's Lemma as presented in Lam's book on Serre's problem \cite{Lam}
%% on projective modules\footnote{This argument is different from the one presented in Lombardi-Quitt\'e \cite{lombardi-quitte}; we instead give a constructive version of the proof of Nashier-Nichols \cite{Nashier}.}.
%% For the general case, we don't follow the Quillen patching technique
%% presented in the 1976 paper \cite{Quillen}, but instead present an argument which uses
%% our description of ${\bP^1}\to{\KR}$.
%% We then explain how we can deduce that $\Aut(\bP^n)$ is $\PGL_{n+1}$.

%%  One point of this work is to show that all these results can be proven axiomatically in the
%%  setting of univalent type theory with the 3 axioms described in \cite{draft}.
%%  ALREADY IN THE INTRODUCTION

% The following result also holds for a general \emph{connected}\footnote{If $e(1-e) = 0$ then $e=0$ or $e=1$.} ring,
% without assuming a finite presentation. 

 \begin{lemma}\label{stand}
   Let $A$ be a \emph{connected}\footnote{If $e(1-e) = 0$ then $e=0$ or $e=1$.} ring, then
   an invertible element of $A[X,1/X]$ can be written $X^N\Sigma a_nX^n$ with $N$ in $\Z$
   and $a_0$ unit and $a_n$ nilpotent if $n\neq 0$.
 \end{lemma}

 \begin{proof}
   Let $P = \sum_i a_iX^i:A[X,1/X]$ be invertible.
   The result is clear if $A$ is an integral domain. Let $B(A)$ is the constructible spectrum of $A$
   with the two generating maps $D(a)$ and $V(a)$ for $a$ in $A$ \cite{lombardi-quitte}. The argument for an integral
   domain, looking at $D(a)$ as $a\neq 0$ and $V(a)$ as $a =0$, shows that we have $\vee_i D(a_i) = 1$
   and $D(a_ia_j) = 0$ for $i\neq j$. Since $A$ is connected, this implies that exactly one $a_i$ is a unit,
   and all the other coefficient are nilpotent.
   %% By duality we can view the coefficients as functions $a_i,b_i:\Spec(A)\to R$.
   %% For all $x:\Spec(A)$, we get an invertible $P_x:R[X,1/X]$ by evaluating the coefficients of $P$ at $x$.
   %% Then $P_x\cdot Q_x=1$ and in particular $1=\sum_{i+j=0}a_ib_j$, so by locality of $R$, we have $i$ such that $a_i$ is invertible.
   %% Without loss of generality, we assume $i=0$ and want to show $\neg\neg (a_j=0)$ for $j\neq 0$.
   %% Since we prove a negated proposition, we can assume that we have $l,k$ minimal with $a_l$ and $b_k$ invertible.
   %% Then we must have $k+l=0$ because we would have $0=a_lb_k$ otherwise.
   %% $k$ was minimal, so it is $0$ and $l$ is $0$ as well.
   %% The same reasoning applies for a maximal choice of $k$.
 \end{proof}

 We can prove in the same way.

 \begin{lemma}\label{nilpunit}
   For any commutative ring $A$, a polynomial $a_0+a_1X+\dots+a_nX^n$ is a unit in $A[X]$ iff
   $a_0$ is a unit and $a_1,\dots,a_n$ are nilpotent. A polynomial $a_0+a_1X+\dots+a_nX^n$ is nilpotent in $A[X]$ iff
   all $a_i$ are nilpotent.
 \end{lemma}
 
 \begin{lemma}\label{connected}
   If $A$ is connected, so is $A[X]$.
 \end{lemma}

 \begin{proof}
   Assume $A$ connected.
   Let $e(X) = a_0+a_1X+\dots+a_nX^n$ be an idempotent element in $A[X]$. Then $a_0$ is idempotent in $A$
   and hence $a_0 = 0$ or $a_0 = 1$. If $a_0 = 0$ then we have $a_1 = 0$ and then $a_2 = \dots = a_n = 0$
   and $e(X) = 0$. If $a_0 = 1$ then $1-e(X)$ is idempotent and we deduce similarly that $1 = e(X)$.
  \end{proof}


 Using Lemma \ref{stand}, we deduce the following, for $A$ connected ring.

\begin{lemma}\label{nilpotent}
  Any invertible element of $A[X,1/X]$ can be written uniquely as a product
  $uX^l(1+a)(1+b)$ with $l$ in $\Z$, $u$ in $A^{\times}$ and $a$ (resp. $b$)
  polynomial in $XA[X]$ (resp. $1/XA[1/X]$) with only nilpotent coefficients.
\end{lemma}

\begin{proof}
  Write $\Sigma v_nX^n$ the invertible element of $A[X,1/X]$.
  W.l.o.g. we can assume, by the previous Lemma, that the polynomial is of the form $v_0 + \Sigma v_nX^n$ with
  all $v_n,~n\neq 0$ nilpotent.
  We let $J$ be the ideal generated by these nilpotent elements.
  We have some $N$ such that $J^N = 0$.
  
  We first multiply by the inverse of $v_0 + \Sigma_{n<0}v_nX^n$, making all coefficients of
  $X^n,~n<0$ in $J^2$.
  We keep doing this until all these elements are $0$.
  %We then do the same, killing all coefficients of $X^n$ for $n>0$.
  We have then written the invertible polynomials on the form $u(1+a)(1+b)$ with $u$ unit in $A$.

  Such a decomposition is unique: if we have $(1+a)(1+b)$ in $A^{\times}$ with $a = \Sigma_{n> 0}a_nX^n$
  and $b = \Sigma_{n<0}b_nX^n$ then we have $a = b = 0$. %$a_n = 0$ for $n>0$ and $b_n = 0$ for $n<0$.
\end{proof}

\begin{corollary}\label{Pic1}
  We have $\prod_{L:\bP^1\rightarrow \KR}\Sigma_{p:\Z}\|L = \OO(p)\|$
\end{corollary}

\begin{proof}
A line bundle $L([x_0,x_1])$ on $\bP^1$ is trivial on each of the affine charts $x_0\neq 0$ and $x_1\neq 0$ by Corollary \ref{c1}, so
it is characterised by an invertible Laurent polynomial on $R$, and the result follows from Lemma \ref{nilpotent}.
\end{proof}

We can then state the following strengthening.

\begin{proposition}\label{Matthias}
  The map $\KR\times\Z\rightarrow (\bP^1\rightarrow \KR)$
  which associates to $(l_0,d)$ the map $x\mapsto l_0\otimes \OO(d)(x)$ is an equivalence.
\end{proposition}

\begin{proof}
  Using Theorem 4.6.3 of \cite{hott}, it is equivalent to show that this map is both surjective and an embedding.
  Corollary \ref{Pic1} shows that this map is surjective.
  So we can conclude by showing that the map is also an embedding.
  For $(l,d),(l',d'):\KR\times\Z$ let us first consider the case $d=d'$. 
  Then we merely have $(l,d)=(\ast,d)$ and $(l',d')=(\ast,d)$,
  so it is enough to note that the induced map on loop spaces based at $(\ast,d)$ is an equivalence by \Cref{const}.
  Now let $d\neq d'$. To conclude we have to show $\OO(k)$ is different from $\OO(0)$ for $k\neq 0$.
  It is enough to show that for $k>0$ the bundle $\OO(k)$ has at least two linear independent sections,
  since we know $\OO(0)$ only has constant sections by \Cref{const}.
  This follows from the fact that $\OO(k)(x)$ is $\Hom_{\Mod{R}}(Rx^{\otimes k},R)$ and has all projections as sections.
  %% which we can naturally identify with $\Hom_{\Mod{R}}(R(x_0^k,x_1^k),R)$ for $x=(x_0,x_1)$.
  %% Then $s_0(r\cdot (x_0^k,x_1^k))\colonequiv r\cdot x_o^k$ and $s_1(r\cdot (x_0^k,x_1^k))\colonequiv r\cdot x_1^k$ define two sections
  %% which are independent since $s_0([0:1])=0\neq s_1([0:1])$ and $s_1([1:0])=0\neq s_1([1:0])$.
  %TC: I think it is clearer not so say too much here. 
\end{proof}

Note that the map $\Z\rightarrow (\bP^1\rightarrow \KR)$ which
associates to $d$ the map $x\mapsto \OO(d)(x)$ is an also surjective, but it is not an embedding.

 It is a curious remark that $\KR\rightarrow \KR$ is also equivalent
 to $\KR\times \Hom_{\mathrm{Group}}(R^\times,R^\times) = \KR\times\Z$.

\begin{corollary}\label{Matthias1}
  We have $\prod_{L:\bP^1\rightarrow \KR}\prod_{x:R}L([1:x]) = L([0:1])$.
\end{corollary}

\begin{proof}
  By the equivalence in \Cref{Matthias}, we have
  \[ \prod_{L:\bP^1\to \KR} \,\prod_{x : \bP^1}  L(x)=l_0\otimes \OO(d)(x) \]
  for some $(l_0,d)$ corresponding to $L$.
  $\OO(d)([0:1])$ can be identified with $R^1$ and $\OO(d)$ is trivial on $R$,
  so we have $L([1:x])=l_0=L([0:1])$ for all $x:R$.
\end{proof}

\section{Line bundles on $\bP^n$}
We will prove $\Pic(\bP^n)=\Z$ and a strengthening thereof in this section by mostly algebraic means.
In \Cref{geometric-proof} we will give a shorter geometric proof.

We can now reformulate Quillen's argument for Theorem 2' \cite{Quillen} in our setting.

\begin{proposition}\label{trivial}
  For all $V:\bP^n\rightarrow \KR$ we have ${\prod_{s:R^n}V([1:s]) = V([0:1:0:\cdots :0])}$.
\end{proposition}

\begin{proof}
  We define $L:R^{n-1}\rightarrow (\bP^1 \to \KR)$ by $L~t~[x_0:x_1] = V([x_0:x_1:x_0t])$.
  Let $s=(s_1,\dots,s_{n}):R^{n}$. We apply Corollary \ref{Matthias1} and we get
  \[
   V([1:s]) = L~(s_2,\dots,s_n)~[1:s_1] = L~(s_2,\dots,s_n)~[0:1] = V([0:1:0:\cdots :0])
   \rlap{.}
  \]
\end{proof}

 Note that the use of Corollary \ref{Matthias1} replaces the use of the ``Quillen patching''
 \cite{lombardi-quitte} introduced in \cite{Quillen} (see Appendix 3).

\medskip

Let $A$ be a commutative ring.
Let $T(A)$ be the ring of polynomials $u = \Sigma_p u(p)X^p$ with
$X^p = X_0^{p_0}\dots X_n^{p_n}$ with $\Sigma p_i = 0$. We write $T_l(A)$ for the subring
of $T$ which contains only monomials $X^p$ with $p_i\geqslant 0$ if $i\neq l$
and $T_{lm}$ the subring of $T$ 
which contains only monomials $X^p$ with $p_i\geqslant 0$ if $i\neq l$ and $i\neq m$.

Note that $T_l(A)$ is the polynomial ring $T_l(A) = A[X_0/X_l,\dots,X_n/X_l]$.

A line bundle on $\bP^n$ is given by compatible line bundles on each $\Spec(T_l(R))$.

The result $\Pic(\bP^n) = \Z$ will be a consequence of the following result, proved in the Appendix.

\begin{proposition}\label{units}
  Let $A$ be a {\em connected} ring and let $t_{ij}$ be a family of  invertible elements in $T_{ij}(A)$ such that $t_{ii} = 1$
  and $t_{ij}t_{jk} = t_{ik}$. There exists an integer $N$ and $s_i$ invertible in $T_i$ such that $t_{ij} = (X_j/X_i)^Ns_j/s_i$ 
\end{proposition}



%% By \Cref{trivial}, a line bundle on $\bP^n$ is trivial on each $\Spec(T_l)$.
%% So it is determined by $t_{ij}$ invertible in $T_i[X_i/X_j] = T_j[X_j/X_i] = T_{ij}$
%% such that $t_{ik} = t_{ij}t_{jk}$ and $t_{ii} = 1$. 
%% Using \Cref{stand}, \Cref{nilpunit} and \Cref{connected}, we can assume without loss of generality, that
%% $t_{ij} = (X_i/X_j)^{N_{ij}} u_{ij}$, for some $N_{ij}$ in $\Z$, where $u_{ij}(p)$ is invertible for $p = 0$
%% and all other coefficients $u_{ij}(p)$ for $p\neq 0$
%% are nilpotent. By looking at the relation  $t_{ik} = t_{ij}t_{jk}$ when we quotient by nilpotent elements, we see that
%% $N_{ij} = N$ does not depend on $i,j$.



\begin{corollary}
  $\Pic(\bP^n) = \Z$.
\end{corollary}

We can then strengthen this result, with the same reasoning as in Proposition \ref{Matthias}.

\begin{theorem}\label{Matthias2}
  The map $\KR\times\Z\rightarrow (\bP^n\rightarrow \KR)$
  which associates to $l_0,d$ the map $x\mapsto l_0\otimes \OO(d)(x)$ is an equivalence.
\end{theorem}

We deduce from this a characterisation of the maps $\bP^n\rightarrow\bP^m$.% using Lemma \ref{hom}.

\begin{corollary}\label{map}
  A map $\bP^n\rightarrow\bP^m$ is given by $m+1$ homogeneous polynomials $p = (p_0,\dots,p_m)$ on $R^{n+1}$
  of the same   degree $d$ such that $x\neq 0$ implies $p(x)\neq 0$.
\end{corollary}

\begin{proof}
Write $E_n(l)$ for $l^{n+1}\setminus\{0\}$. We have $\bP^n = \Sigma_{l:\KR}E_n(l)$ and so
$$
\bP^n\rightarrow\bP^m = \sum_{s:\bP^n\rightarrow \KR}\prod_{x:\bP^n}E_m(s~x)
$$
Using Theorem \ref{Matthias2}, this is equal to
$$
\sum_{l_0:\KR}\sum_{d:\Z}\prod_{l:\KR}E_n(l)\rightarrow E_m(l_0\otimes l^{\otimes d})
$$
and, as for Lemma \ref{hom}, this is the set of tuples of $m+1$ polynomials in $R[X_0,\dots,X_n]$ homogenenous
of degree $d$, sending $x\neq 0$ to $p(x)\neq 0$, and quotiented by proportionality.
\end{proof}

We deduce the characterisation of $\Aut(\bP^n)$. This is a
remarkable result, since the automorphisms are in this framework only bijections of sets.

\begin{corollary}
  $\Aut(\bP^n)$ is $\PGL_{n+1}(R)$.
\end{corollary}

It follows from Corollary \ref{affine} that $\PGL_{n+1}(R)$ is affine.

\medskip

Note that this is an {\em internal} result about functor of points over a category of
finitely presented $k$-algebras for some commutative ring $k$ \cite{draft}. We have an exact sequence
$$
1\rightarrow R^{\times}\rightarrow GL_{n+1}(R)\rightarrow \PGL_{n+1}(R)\rightarrow 1
$$
and the global sections of $\PGL_{n+1}(R)$ is only $\PGL_{n+1}(k)$ if $\Pic(k)\neq 0$.

In general, over a commutative ring,
there can be automorphisms of $\bP^n(k)$ which cannot be described as an element of $GL_{n+1}(k)$.
For an example, let $k$ be the ring $\ints[x]$ with $x^2+5=0$ and let $m$ be the matrix
\[
m =
\begin{pmatrix}
  1+x & -2 \\
  -2 & 1-x \\
\end{pmatrix}  
\]
Its determinant is $2$, not unit in $k$, and $x\mapsto m^{-1}xm$ defines an automorphism of $M_2(k)$
which is {\em not} inner, but only locally inner \cite{Isaacs}, Example 6. This automorphism defines an
automorphism of $\bP^1(k)$, since a point of $\bP^1(k)$ is a submodule of $k^2$, projective of rank $1$ and factor direct,
which can be seen as an idempotent of $M_2(k)$. One can check that
this automorphim sends the free submodule $k(1,0)$ to the submodule generated by $(3,1+x)$ and $(-1+x,-2)$,
which is not free. This shows that this automorphism cannot be defined by an element of $GL_2(k)$.

\medskip

We also have the following application of computation of cohomology groups \cite{draft}.

\begin{corollary}
A function $\bP^n\rightarrow\bP^m$ is constant if $n>m$.
\end{corollary}

\begin{proof}
We proved in \cite{cech-draft} that cohomology groups can be computed as Cech cohomology for any
finite open acyclic covering and used this to prove $H^n(\bP^n,\OO(-n-1))=R$.
By \Cref{map}, a map $\bP^n\rightarrow\bP^m$ is given by $m+1$ non zero polynomials
$p(x) = (p_0(x),\dots,p_m(x))$ homogeneous of the same degree $d\geqslant 0$ and such that $x\neq 0$ implies $p(x)\neq 0$.
This means that $\bP^n$ is covered by $m+1$ open subsets $U_i(x)$ defined by $p_i(x)\neq 0$.
I claim that we should have $d=0$.

 If $q(x)$ is a non zero homogeneous polynomial of degree $d>0$, the open $q(x)\neq 0$ defines an {\em affine}
 and hence acyclic \cite{cech-draft}, open subset of $\bP^n$ by Corollary \ref{affine}, and so is each finite
 intersection $U_{i_1}\cap\dots\cap U_{i_l}$. So if $d>0$, the covering $U_0,\dots,U_m$ is acyclic.
 If we compute $H^n(\bP^n,\OO(-n-1))$ with respect to {\em this} covering, we get that
 $H^n(\bP^n,\OO(-n-1)) = 0$ since $m<n$. But this contradicts $H^n(\bP^n,\OO(-n-1))=R$.

 Hence $d=0$ and the map is constant.
\end{proof}
