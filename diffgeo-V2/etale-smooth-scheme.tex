\subsection{Smooth and étale maps between schemes}

Note that it is immediate from the definition of smoothness that smooth maps induce surjections on tangent spaces. We have a converse when the domain is smooth.

\begin{corollary}\label{smooth-schemes-iff-submersion}
Let $f:X\to Y$ be a map between schemes with $X$ smooth. Then the following are equivalent:
\begin{enumerate}[(i)] 
\item The map $f$ is smooth.
\item For all $x:X$, the induced map:
\[df : T_x(X)\to T_{f(x)}(Y)\]
is surjective.
\end{enumerate}
\end{corollary}

\begin{proof}
(i) implies (ii). Assume given a map $v:\D(1)\to Y$ such that $v(0)=f(x)$, then for all $t:\D(1)$ we have a map:
\[t=0 \to \fib_f(v(t))\]
so since the $f$ is smooth we merely have $w_t:\fib_f(v(t))$ such that $t=0$ implies $w_t=0$. We conclude using choice over $\D(1)$.

(ii) implies (i). Assume given $y:Y$ and $\epsilon:R$ such that $\epsilon^2=0$ and try to merely find a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        \epsilon=0\ar[r,"\phi"]\ar[d] & \fib_f(y)\\
       1 \ar[ru,dashed] & \\
      \end{tikzcd}
    \end{center}
    Since $X$ is formally smooth we merely have an $x:X$ such that:
\[\prod_{p:\epsilon=0} \phi(p)=x\]
and therefore:
\[ \epsilon=0 \to y=f(x)\]
which means that $y\in N_1(f(x))$. We use \cref{neighborhood-tangent-correspondence-smooth} to get that the map $N_1(x)\to N_1(f(x))$ merely has a section $s$ sending $f(x)$ to $x$.

Then $s(y):\fib_f(y)$ such that for all $p:\epsilon=0$ we have that:
\[\phi(p) = x = s(f(x)) = s(y)\]
\end{proof}

\begin{corollary}\label{etale-schemes-iff-local-iso}
Let $f:X\to Y$ be a map between schemes. Assume $X$ is smooth. Then the following are equivalent:
\begin{enumerate}[(i)]
\item The map $f$ is étale. 
\item For all $x:X$, the induced map:
\[df : T_x(X)\to T_{f(x)}(Y)\]
is an iso.
\end{enumerate}
\end{corollary}

\begin{proof}
We apply \cref{unramified-map-characterisation} and \cref{smooth-schemes-iff-submersion}.
\end{proof}



\subsection{Smooth schemes have free tangent spaces}


\begin{lemma}\label{smooth-implies-smooth-tangent}
Assume $X$ is a smooth scheme. Then for any $x:X$ the type $T_x(X)$ is formally smooth.
\end{lemma}

\begin{proof}
Consider $T(X) = X^{\mathbb{D}(1)}$ the total tangent bundle of $X$. We have to prove that the map:
\[p:T(X)\to X\]
is formally smooth. Both source and target are schemes, and the source is formally smooth because $X$ is smooth and $\mathbb{D}(1)$ has choice. So by \cref{smooth-schemes-iff-submersion} it is enough to prove that for all $x:X$ and $v:T_x(X)$ the induced map:
\[dp:T_{(x,v)}(T(X))\to T_x(X)\]
is surjective. 

Consider $w:T_x(X)$. By unpacking the definition of tangent spaces, we see that merely finding $w:T_{(x,v)}(T(X))$ such that $dp(w) = w$ means merely finding:
\[\phi : \mathbb{D}(1) \times \mathbb{D}(1) \to X\]
such that for all $t:\mathbb{D}(1)$ we have that:
\[\phi(0,t) = v(t)\]
\[\phi(t,0) = w(t)\]

But we know that there exists a unique:
\[\psi_{v,w} : \mathbb{D}(2)\to X\]
such that:
\[\psi_{v,w}(0,t) = v(t)\]
\[\psi_{w,v}(t,0) = w(t)\]
as defined in \cref{from-D1-to-D2}.

Then the fact that $X$ is smooth and that the fibers of:
\[\mathbb{D}(2) \to\mathbb{D}(1) \times \mathbb{D}(1) \]
are closed dense with $\mathbb{D}(1) \times \mathbb{D}(1)$ having choice means that there merely exists a lift of $\psi_{v,w}$ to $\mathbb{D}(1) \times \mathbb{D}(1)$, which gives us the $\phi$ we wanted.
\end{proof}

\begin{lemma}\label{smooth-kernel-decidable}
Assume given a linear map:
\[M:R^m\to R^n\] 
which has a formally smooth kernel. Then we can decide whether $M=0$.
\end{lemma}

\begin{proof}
Since $M=0$ is closed, it is enough to prove that it is $\neg\neg$-stable to conclude that it is decidable by \cref{not-not-stable-prop-etale} and \cref{closed-and-etale-decidable}. Assume $\neg\neg(M=0)$, then for any $x:R^m$ we have a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        M=0\ar[d] \ar[r,"\_\mapsto x"] & K \\
       1 \ar[dotted,ru] &
      \end{tikzcd}
\end{center}
because $K$ is formally smooth, so that we merely have $y:K$ such that: 
\[M=0\to x=y\]
which implies that $\neg\neg(x=y)$ since we assumed $\neg\neg(M=0)$.

Then considering a basis $(x_1,\cdots,x_n)$ of $R^m$, we get $(y_1,\cdots,y_n)$ such that for all $i$ we have that $M(y_i) = 0$ and $\neg\neg(y_i=x_i)$. But then we have that $(y_1,\cdots,y_n)$ is infinitesimally close to a basis and that being a basis is an open proposition, so that $(y_1,\cdots,y_n)$ is a basis and $M=0$.
\end{proof}

\begin{lemma}\label{smooth-corpresented-implies-free}
Assume that $K$ is a finitely copresented module that is also formally smooth. Then it is finite free.
\end{lemma}

\begin{proof}
Assume a finite copresentation:
\[0\to K\to R^m\overset{M}{\to} R^n\]
We proceed by induction on $m$. By \cref{smooth-kernel-decidable} we can decide whether $M=0$ or not.
\begin{itemize}
\item If $M=0$ then $K=R^m$ and we can conclude.
\item If $M\not=0$ then we can find a non-zero coefficient in the matrix corresponding to $M$, and so up to base change it is of the form:

\[
\begin{pmatrix}
1 & \begin{matrix}0&\cdots & 0\end{matrix}  \\
\begin{matrix}0\\ \vdots\\ 0\end{matrix} & \widetilde{M} \\
\end{pmatrix}
\]

But then we know that the kernel of $M$ is equivalent to the kernel of $\widetilde{M}$, and by applying the induction hypothesis we can conclude that it is finite free.
\end{itemize}
\end{proof}

\begin{proposition}\label{smooth-have-free-tangent}
Let $X$ be a smooth scheme. Then for any $x:X$ we have that $T_x(X)$ is finite free.
\end{proposition}

\begin{proof}
By \cref{smooth-implies-smooth-tangent} we have that $T_x(X)$ is formally smooth, so that we can conclude by \cref{smooth-corpresented-implies-free}.
\end{proof}

The dimension of $T_x(X)$ is called the dimension of $X$ at $x$. By boundedness any smooth scheme is a finite sum of smooth scheme of a fixed dimension.


\subsection{Standard étale and standard smooth schemes}

\begin{definition}
A standard smooth scheme of dimension $k$ is an affine scheme of the form:
\[\Spec\big((R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n)_G\big)\]
where $G$ divides the determinant of:
\[\left( \frac{\partial P_i}{\partial X_j}\right)_{1\leq i,j\leq n}\]
in:
\[R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n\]
\end{definition}

\begin{definition}
A standard smooth scheme of dimension $0$ is called a standard étale scheme.
\end{definition}

\begin{lemma}\label{standard-etale-are-etale}
Standard étale schemes are étale.
\end{lemma}

\begin{proof}
Assume given a standard étale algebra:
\[(R[X_1,\cdots,X_n]/P_1,\cdots,P_n)_G\]
and write:
\[P:R^n\to R^m\]
for the map induced by $P_1,\cdots,P_m$.

Assume given $\epsilon:R$ such that $\epsilon^2=0$, we need to prove that there is a unique dotted lifting in:
  \begin{center}
      \begin{tikzcd}
       R/\epsilon & (R[X_1,\cdots,X_n]/P_1,\cdots,P_n)_G\ar[l,swap,"x"]\ar[dotted,ld] \\
       R\ar[u]&
      \end{tikzcd}
    \end{center}
This means that for all $x:R^n$ such that $P(x)=0$ mod $\epsilon$ and $G(x)$ invertible modulo $\epsilon$ (or equivalently $G(x)$ invertible), there exists a unique $y:R^n$ such that:
\begin{itemize} 
\item We have $x=y$ mod $\epsilon$.
\item We have $P(y)=0$.
\item We have $G(y)\not=0$ (this is implied by $x=y$ mod $\epsilon$ and $G(x)\not=0$).
\end{itemize}

First we prove existence. For any $b:R^n$ we compute:
\[P(x+\epsilon b) = P(x) + \epsilon\ dP_x(b)\]
We have that $P(x)=0$ mod $\epsilon$, say $P(x) = \epsilon a$. Then since $G(x)\not=0$ and $\mathrm{det}(dP)$ divides $G$, we have that $dP_x$ is invertible. Then taking $b = -(dP_x)^{-1}(a)$ gives a lift $y=x+\epsilon b$ such that $P(y) = 0$.

Now we check unicity. Assume $y,y'$ two such lifts, then $y=y'$ mod $\epsilon$ and we have:
\[P(y) = P(y') + dP_{y'}(y-y')\]
and $P(y)=0$ and $P(y')=0$ so that:
\[dP_{y'}(y-y') = 0\]
But $G(y')\not=0$ so $dP_{y'}$ is invertible and we can conclude that $y=y'$.
\end{proof}

\begin{lemma}\label{standard-smooth-is-smooth}
Any standard smooth scheme of dimension $k$ is formally smooth of dimension $k$.
\end{lemma}

\begin{proof}
The fibers of the map:
\[\Spec\big((R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n)_G\big) \to \Spec(R[Y_1,\cdots Y_{k}])\]
are standard étale, so the map is étale by \cref{standard-etale-are-etale}. Since:
\[\Spec(R[Y_1,\cdots Y_{k}]) = \A^k\]
is smooth by \cref{An-is-smooth}, we can conclude it is smooth using \cref{smooth-sigma-closed}. 

For the dimension we use \cref{An-dimension-n} and \cref{etale-schemes-iff-local-iso}.
\end{proof}



\subsection{Smooth schemes are locally standard smooth}

\begin{proposition}\label{smooth-are-locally-standard}
A scheme is smooth of dimension $k$ if and only if it has a finite open cover by standard smooth schemes of dimension $k$.
\end{proposition}

\begin{proof}
We can assume the scheme $X$ affine, say of the form:
\[X = \Spec(R[X_1,\cdots,X_m]/P_1,\cdots,P_l)\]

By \cref{smooth-have-free-tangent}, for any $x:X$ we have that $dP_x$ has free kernel. We partition by the dimension $n$ of the kernel. Then by \cref{rank-equivalent-definitions} we know that $dP_x$ has rank $n$ for every $x$.

We cover $X$ according to which $n$-minor is invertible, so that up to a rearranging of variables and polynomials we can assume that:
\[X = \Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n,Q_1,\cdots, Q_l)\]
where we have:
\[dP_{x,y} = \begin{pmatrix}
\left(\frac{\partial P}{\partial X}\right)_{x,y} & \left(\frac{\partial P}{\partial Y}\right)_{x,y} \\
\left(\frac{\partial Q}{\partial X}\right)_{x,y} & \left(\frac{\partial Q}{\partial Y}\right)_{x,y} \\
\end{pmatrix}\]
where we used the notation:
\[\left(\frac{\partial P}{\partial X}\right)_{x,y} = \begin{pmatrix}\left(\frac{\partial P_i}{\partial X_j}\right)_{x,y}\end{pmatrix}_{i,j}\]
so that $\frac{\partial P}{\partial X}$ is invertible of size $n$. Moreover by \cref{rank-bloc-matrix} we get:
\[\left(\frac{\partial Q}{\partial Y}\right)_{x,y} = \left(\frac{\partial Q}{\partial X}\right)_{x,y}\left(\frac{\partial P}{\partial X}\right)_{x,y}^{-1} \left(\frac{\partial P}{\partial Y}\right)_{x,y} \]
which will be useful later.

Now we prove that for any $(x,y):R^{n+k}$ such that $P(x,y)=0$ it is decidable whether
\[Q(x,y)=0 \] 
To do this it is enough to prove that:
\[(Q_1(x,y),\cdots,Q_l(x,y))^2=0 \to (Q_1(x,y),\cdots,Q_l(x,y))=0\]
Assuming $(Q_1(x,y),\cdots,Q_l(x,y))^2=0$, by smoothness there is a dotted lifting in:
 \begin{center}
      \begin{tikzcd}
        R/(Q_1(x,y),\cdots,Q_l(x,y)) & \Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n,Q_1,\cdots, Q_l)\ar[l,swap,"(x{,}y)"] \ar[dotted,ld,"(x{'}{,}y{'})"]\\
       R\ar[u] & \\
      \end{tikzcd}
\end{center}
Let us prove that $Q(x,y) = 0$. Indeed we have $(x,y) \sim_1 (x',y')$ so that we have:
\[P(x,y) = P(x',y')+ \left(\frac{\partial P}{\partial X}\right)_{x',y'}(x-x') + \left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y') \]
\[Q(x,y) = Q(x',y')+ \left(\frac{\partial Q}{\partial X}\right)_{x',y'}(x-x') + \left(\frac{\partial Q}{\partial Y}\right)_{x',y'}(y-y') \]
Then we have $P(x,y) = 0$, $P(x',y')=0$ and $Q(x',y') = 0$. From the first equality we get:
\[x-x' =  -\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1}\left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y')\]
so that from the second we get:
\[Q(x,y) = -\left(\frac{\partial Q}{\partial X}\right)_{x',y'}\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1}\left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y') + \left(\frac{\partial Q}{\partial Y}\right)_{x',y'}(y-y')\]
so that $Q(x,y)=0$ as we have seen previously that:
\[\left(\frac{\partial Q}{\partial Y}\right)_{x',y'} = \left(\frac{\partial Q}{\partial X}\right)_{x',y'}\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1} \left(\frac{\partial P}{\partial Y}\right)_{x',y'} \]

From the decidability of $Q(x,y)=0$ we get that $X$ is an open in:
\[\Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n)\]
so it is of the form $D(G_1,\cdots,G_n)$, and we have an open cover of our scheme by pieces of the form:
    \[\Spec((R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n)_G)\]
    Where $P_i(x)=0$ for all $i$ and $G(x)\not=0$ implies:
    \[\mathrm{det}(\mathrm{Jac}(P_1,\cdots,P_n)_x)\not=0\]
    
    We write:
    \[F(x)=\mathrm{det}(\mathrm{Jac}(P_1,\cdots,P_n)_x)\]
    Then for all $x:\Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n)$ we have that:
    \[(G(x)\not=0) \to (F(x)\not=0)\]
    so that there exists $n$ such that:
    \[F(x) | G(x)^n\]
    and using boundedness we get $N$ such that for all $x:\Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n)$ we have:
    \[F(x) | G(x)^N\]
    and we conclude that $F$ divides $G^N$ in $R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n$. So by replacing $G$ by $G^N$, we get standard smooth pieces.
\end{proof}

\begin{corollary}
A scheme is formally étale if and only if it has a cover by standard étale schemes.
\end{corollary}

\begin{proof}
By \cref{unramified-scheme-characterisation} we know that a scheme is formally étale if and only if it is smooth of dimension $0$. Then we just apply \cref{smooth-are-locally-standard}.
\end{proof}
