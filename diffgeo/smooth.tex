
\subsection{Smooth maps}

\begin{definition}
A morphism $f:X\to Y$ is formally smooth if for any closed dense proposition $P$,
any square:
 \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & X\ar[d,"f"] \\
       1 \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
merely has a lift.
\end{definition}

\begin{lemma}
For any morphism  $f:X\to Y$ the following are equivalent:
\begin{enumerate}[(i)]
\item The map $f$ is formally smooth. 
\item For any $\epsilon:R$ such that $\epsilon^2=0$, there merely exists a lift to any square:
 \begin{center}
      \begin{tikzcd}
        \epsilon=0\ar[r]\ar[d] & X\ar[d,"f"] \\
       1 \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (i) implies (ii). Conversely any map $P\to 1$ for $P$ dense closed can be decomposed as:
\[P_n \to P_{n-1} \to P_1\to 1\]
where:
\begin{itemize}
\item For all $k$ we have that $P_k$ is the spectrum of a local ring so it has choice.
\item For all $k$ the map:
\[P_{k}\to P_{k-1}\]
is of the form:
\[\Spec(A/a)\to \Spec(A)\]
where $a^2=0$.
\end{itemize}
Then by (ii) we can merely find a lift pointwise to $P_k\to P_{k-1}$, and since $P_{k-1}$ has choice we merely get a global lift. By iterating we merely get a lift to $P\to 1$.
\end{proof}

\begin{remark}
The usual definition for formally smooth is to ask for lifting in:
 \begin{center}
      \begin{tikzcd}
        \Spec(A/N)\ar[r]\ar[d] & X\ar[d,"f"] \\
       \Spec(A) \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
    with $N$ nilpotent. Note that here since we do not have: 
\[
\prod_{x:A} ||B(x)|| \to ||\prod_{x:A}B(x)||
\]
we do not have a direct analogue to \cref{equivalence-etale} or \cref{equivalence-unramified}.
\end{remark}

Our definition of formal smoothness is convenient because it implies:

\begin{lemma}
A map is formally smooth if and only if its fibers are formally smooth.
\end{lemma}
\begin{proof}
The type of filler for:
 \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & X\ar[d,"f"] \\
       1 \ar[r,"y"]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
   is equivalent to the type of filler for:
    \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & \mathrm{fib}_f(y) \\
       1 \ar[ru,dashed] & 
      \end{tikzcd}
    \end{center}
\end{proof}

\begin{remark}
Formally smooth and formally unramified implies formally étale.
\end{remark}

\subsection{Examples}

We give a few examples and counter-examples:

\begin{lemma}
The scheme $\A^n$ is smooth for any $n$.
\end{lemma}

\begin{proof}
We need to prove that there merely exists a dotted lift in any:
 \begin{center}
      \begin{tikzcd}
        R/N & R[X_1,\cdots,X_n]\ar[l]\ar[ld,dashed] \\
        R \ar[u]& 
      \end{tikzcd}
    \end{center}
    It is enough to choose a lift for each $X_i$.
\end{proof}

\begin{lemma}
A type covered by finitely many formally smooth subtypes is formally smooth.
\end{lemma}
\begin{proof}
We assume $P_1,\cdots,P_n:X\to \Prop$ covering $X$, i.e. for all $x:X$ we have:
\[
\prod_{x:X}P_1(x)\lor\cdots\lor P_n(x)
\]
such that $\Sigma_{x:X}P_i(x)$ is formally smooth for all $i$.

Assume given:
   \begin{center}
      \begin{tikzcd}
        P\ar[r,"\phi"]\ar[d] &X \\
       1 \ar[ru,dashed] & 
      \end{tikzcd}
    \end{center}
   then we have:
   \[\prod_{p:P} P_1(\phi(p))\lor\cdots\lor P_n(\phi(p))\]
   so that for some $i$ we have:
      \[\prod_{p:P} P_i(\phi(p))\]
as $P$ is closed. So $\phi$ factors through $\Sigma_{x:X}P_i(x)$ which is formally smooth and we can conclude. %Then we can simply lift in $P_i$, which is assumed    
\end{proof}

\begin{corollary}
The scheme $\mathbb{P}^n$ is smooth for any $n$.
\end{corollary}

\begin{lemma}
The scheme $\D(1)$ is not smooth.
\end{lemma}

\begin{proof}
If it were smooth, for any $\epsilon$ with $\epsilon^3=0$ we would be able to prove $\epsilon^2=0$.
Indeed we would merely have a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        R/(\epsilon^2)& R[X]/(X^2)\ar[l,"\epsilon"]\ar[ld,dashed] \\
        R \ar[u]& 
      \end{tikzcd}
    \end{center}
    that is, an $r:R$ such that $(\epsilon+r\epsilon^2)^2=0$. Then $\epsilon^2=0$.
\end{proof}

\begin{lemma}
The scheme $\Spec(R[X,Y]/(XY))$ is not smooth.
\end{lemma}

\begin{proof}
If it were smooth, for any $\epsilon$ with $\epsilon^3=0$ we would be able to prove $\epsilon^2=0$.
Indeed we would merely have a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        R/(\epsilon^2) & R[X,Y]/(XY)\ar[l]\ar[ld,dashed] \\
        R\ar[u] & 
      \end{tikzcd}
    \end{center}
    where the top map sends both $X$ and $Y$ to $\epsilon$. Then we have $r,r':R$ such that $(\epsilon+r\epsilon^2)(\epsilon+r'\epsilon^2)=0$ so that $\epsilon^2=0$. %This can't be done.
\end{proof}

\begin{lemma}
The map:
\[
p:\Spec(R[X,Y]/(XY))\to \A^1
\] 
corresponding to the map:
\[
R[X,Y]/(XY) \leftarrow R[X]
\]
sending $X$ to $X$ is not smooth.
\end{lemma}

\begin{proof}
If it were smooth all its fibers would be smooth,
i.e.\ for all $z:R$ the scheme $\Spec(R[X]/(zX))$ would be smooth.
This would imply that for any $\epsilon:R$ such that $\epsilon^2=0$ we merely have a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        R/\epsilon & R[X]/(\epsilon X)\ar[l]\ar[ld,dashed] \\
        R \ar[u]& 
      \end{tikzcd}
    \end{center} 
    where the top map sends $X$ to $1$.
    Such a lift gives an $r:R$ such that $\epsilon(1+r\epsilon)=0$, so that $\epsilon=0$.
\end{proof}

I think in the traditional setting this map has smooth fibers, but not here. 

\subsection{Stability properties}

Now we give stability properties for formally smooth types. We start by expected ones:

\begin{lemma}
If $X$ is a type satifying choice and for all $x:X$ we have a formally smooth type $Y_x$, then:
\[\prod_{x:X}Y_x\]
is formally smooth.
\end{lemma}

So for example formally smooth types are stable by finite products. 

\begin{lemma}
\label{smooth-sigma-closed}
If $X$ is a formally smooth type and for all $x:X$ we have a formally smooth type $Y_x$, then:
\[\sum_{x:X}Y_x\]
is formally smooth.
\end{lemma}

Formally smooth types are not stable by identity types (e.g. identity types in $\A^1$ are not smooth, otherwise they would be closed and étale, i.e. decidable).

One typically expects quotienting to sometimes break smoothness. Surprisingly, this is not the case in our setting when using homotopy quotients:

\begin{proposition}
\label{smoothSurjective}
The image of a formally smooth type by any map is formally smooth.
\end{proposition}
\begin{proof}
We assume $X$ formally smooth and $p:X\to Y$ surjective. Then for any $P$ closed dense and any diagram:
 \begin{center}
      \begin{tikzcd}
      P \ar[rd,dotted]\ar[d]\ar[r]& Y\\
      1 \ar[r,dotted,swap,"x"]& X\ar[u,swap,"p"]
      \end{tikzcd}
    \end{center} 
    by choice for closed propositions we merely get the dotted diagonal, and since $X$ is formally smooth we get the dotted $x$, and then $p(x)$ gives a lift.
\end{proof}

\begin{lemma}\label{pointed-connected-smooth}
Any pointed connected type $X$ is formally smooth.
\end{lemma}

\begin{proof}
We have a surjection:
\[1\to X\]
and $1$ is formally smooth so we conclude by \cref{smoothSurjective}.
\end{proof}

Formal smoothness is really about sets in some way:

\begin{lemma}
A type $X$ is formally smooth if and only if its set truncation $\propTrunc{X}_0$ is formally smooth.
\end{lemma}

\begin{proof}
Consider the map:
\[p:X\to \propTrunc{X}_0\]
\begin{itemize}
\item If $X$ is formally smooth, then since $p$ is surjective we conclude using \cref{smoothSurjective}.
\item The map $p$ has merely inhabited connected fibers so by \cref{pointed-connected-smooth} it is formally smooth, so that if $\propTrunc{X}_0$ is formally smooth so is $X$ by \cref{smooth-sigma-closed}.
\end{itemize}
\end{proof}


\subsection{Equivalence with the usual definition for maps between schemes}

Here we prove that our definition coincides with the usual one for maps with scheme fibers.

\begin{lemma}\label{lifting-is-torsor}
Let $X$ be a scheme and $\epsilon:R$ such that $\epsilon^2=0$. Then the type of liftings of:
 \begin{center}
      \begin{tikzcd}
      \epsilon=0 \ar[d]\ar[r,"\phi"]& X\\
      1 & 
      \end{tikzcd}
    \end{center} 
is an $M$-pseudotorsor where:
\[M = \Hom_{R/\epsilon}\big(\prod_{p:\epsilon=0}T^\star_{\phi(p)}(X),(\epsilon)\big)\]
\end{lemma}

\begin{proof}
TODO
\end{proof}

Another proof:
\begin{remark}
  \label{connection-to-ega-definition}
  Let $f:X\to Y$ be a map between schemes.
  Then $f$ is étale (resp. smooth, unramified) if and only if there exists exactly one (resp. at least one, at most one) dotted lift in all squares of the form:
  \begin{center}
    \begin{tikzcd}
      \Spec(A/N)\ar[r,"t"]\ar[d] & X\ar[d,"f"] \\
      \Spec(A)\ar[ru,dashed]\ar[r,swap,"b"] & Y
    \end{tikzcd}    
  \end{center}
where $A$ is a finitely presented $R$-algebra, $N$ a finitely generated nilpotent ideal and the left map is induced by the quotient map $A\to A/N$. 
\end{remark}

\begin{proof}
  The inclusion of a closed dense proposition $P$ into $1$ is a special case of left map in the remark, so we only need to show that étale,
  smooth and unramified maps satisfy the more general lifting property. For étale and unramified maps, we can just apply the lifting property for closed dense propositions for all points in $\Spec A$. So let $f:X\to Y$ be smooth.
  
  By decomposing as in the proof of \Cref{etale-unramified-smooth-square-zero}, we can assume without loss of generality that $N$ is of the form $(a)$ with $a^2=0$.
  Then the existence of a lift can be shown
  by finding a family of lifts for each point $v:\Spec A$ with $\epsilon:=a(v)$ and $\phi$ induced by $t$:
  \begin{center}
    \begin{tikzcd}
      \epsilon=0\ar[r,"\phi"]\ar[d] & \fib_f(b(v))=:X_v \\
      1\ar[ur,dotted] &
    \end{tikzcd}
  \end{center}
  For any two lifts $\psi,\xi$, we have $\neg\neg(\psi=\xi)$
  and can therefore assume $X_v=\Spec R[X_1,\dots,X_n]/P_1,\dots,P_l$.
  We merely have $y:R^n$ such that the dual to $\phi$ is given by evaluation at $y$.
  Then lifts are given by vectors $x:R^n$ such that $P(x)=0$ and $\epsilon = 0$ implies $x=y$.
  The latter dualizes to an inclusion of ideals $(x_1-y_1,\dots,x_n-y_n)\subseteq (\epsilon)$.
  So we have $x_i-y_i=a_i\epsilon$.
  Putting everything together, we get the following type of lifts:
  \[L_{v,y}:=\sum_{\alpha:(\epsilon)^n}dP_y(\alpha)=-P(y) \]
  Let $M_{v,y}:=\{\alpha:(\epsilon)^n\vert dP_y(\alpha)=0\}$, then  $M_{v,y}$ is a wqc $R$-module and $L_y$ has the structure of an $M_{v,y}$-torsor.
  For a different choice $y':R^n$, also inducing $\phi$, we get $y'=y+\beta$ for some $\beta:(\epsilon)^n$.
  By computing $P(y'+\alpha)$ in different ways we have:
  \[P(y)+dP_y(\beta+\alpha)=P(y+\beta)+dP_{y+\beta}(\alpha)=P(y)+dP_y(\beta)+dP_{y+\beta}(\alpha)\]
  And therefore $dP_y(\beta+\alpha)=dP_y(\beta)+dP_{y+\beta}(\alpha)$ and $dP_{y+\beta}(\alpha)=dP_y(\alpha)$, which means that $M_{v,y}$ is independent of $y$, so let us write $M_v$ instead.
  We also have:
  \[L_{v,y'}=\sum_{\alpha:(\epsilon)^n}dP_y(\beta+\alpha)=-P(y)\]
  so translation by $\beta$ give a isomorphism of $M_{v}$-torsors.
  So we get a well-defined $M_v$-torsor $L_v$ by Krauss' Lemma for 1-types.
  Then by \cite{draft}, $H^1(v:\Spec A, M_v)$ vanishes and we therefore have a global lift. 
\end{proof}


\begin{lemma}\label{M-is-wqc}
The $R$-module $M$ from the previous lemma is wqc.
\end{lemma}

\begin{proof}
For any $p:\epsilon=0$ we have that $T^\star_{\phi(p)}(X)$ is a finitely presented $R$-module, so that:
\[N = \prod_{p:\epsilon=0}T^\star_{\phi(p)}(X)\]
is a finitely presented $R/\epsilon$-module. Assume a presentation:
\[
(R/\epsilon)^m \to (R/\epsilon)^n\to N\to 0
\]
then we have an exact sequence of $R$-modules:
\[
0\to \Hom_{R/\epsilon}(N,(\epsilon)) \to (\epsilon)^n\to (\epsilon)^m
\]
but $(\epsilon)$ is wqc so that $\Hom_{R/\epsilon}(N,(\epsilon))$ is the kernel of a map between wqc $R$-modules and it is wqc.
\end{proof}

\begin{proposition}
Let $p:X\to Y$ be a map which fibers are schemes. Then $p$ merely having lifts against the following classes of maps is equivalent:
\begin{enumerate}[(i)]
\item The maps $\epsilon=0\to 1$ where $\epsilon^2=0$.
\item The maps $P\to 1$ where $P$ is closed dense (i.e. $p$ being formally smooth).
\item The maps $\Spec(A/a)\to \Spec(A)$ where $A$ fp $R$-algebra and $a^2=0$.
\item The maps $\Spec(A/N)\to \Spec(A)$ where $A$ fp $R$-algebra and $N$ fg nilpotent ideal.
\end{enumerate}
\end{proposition}

\begin{proof}
It is enough to prove that (i) implies (iii), as any map in (iv) is a composite of maps in (iii). Assume a diagram:
 \begin{center}
      \begin{tikzcd}
      \Spec(A/a) \ar[d]\ar[r]& X\ar[d,"p"]\\
      \Spec(A) \ar[r] & Y
      \end{tikzcd}
    \end{center} 
    with $a^2=0$, we try to merely find a lift. By \cref{lifting-is-torsor}, we know that the type of lifts over $x:\Spec(A)$ is an $M_x$-pseudotorsor. By hypothesis (i) this is in fact an $M_x$-torsor. Mere existence of a lift for the diagram is then precisely a mere section of the dependent torsor $(x:\Spec(A))\mapsto M_x$, i.e. a proof that it is merely trivial. But $M_x$ is wqc by \cref{M-is-wqc} so that $H^1(\Spec(A),M)=0$ by \cite{draft}[Theorem 8.3.6] and any $M$-torsor is merely trivial, meaning we merely have a lift.
\end{proof}

\subsection{Smooth schemes and Jacobians (obsolete?)}

\begin{lemma}
Assume given a smooth affine scheme:
\[X = \Spec(R[X_1,\cdots,X_n]/P_1,\cdots,P_m)\]
such that for all $x:X$ the Jacobian:
\[J(x) : R^n \to R^m\]
is surjective. Then $X$ is smooth.
\end{lemma}

\begin{proof}
We write $P: R^n\to R^m$ the map sending $x$ to $(P_1(x),\cdots,P_m(x))$. Assume given $\epsilon:R$ such that $\epsilon^2 = 0$. For any:
 \begin{center}
      \begin{tikzcd}
      R/\epsilon & R[X_1,\cdots,X_n]/P_1,\cdots,P_m\ar[l]\ar[ld,dotted]\\
      R\ar[u] &  \\
      \end{tikzcd}
    \end{center} 
    we need to find a dotted lift. This means that given $x:R^n$ such that $P(x)=0$ mod $\epsilon$, we need to merely find $y:R^n$ such that $P(x+\epsilon y) = 0$. But since $\epsilon^2=0$, we have that:
    \[P(x+\epsilon y) = P(x) + \epsilon J(x)y\]
    But we know that $P(x)$ is merely equal to $\epsilon z$ for some $z$ in $R^m$, so to conclude it is enough to prove $J(x)$ surjective. But $J(x)$ being surjective is an open proposition as it can be expressed as the invertibility of some determinants, so in particular it is $\neg\neg$-stable. Since $P(x)=0$ implies $J(x)$ surjective and we have $\neg\neg(P(x)=0)$ we can conclude.
\end{proof}

We want to show some kind of converse. We start with a simple case, when $m=1$. First an auxiliary lemma.

\begin{lemma}\label{order-smooth-add-one}
Assume given:
\[P : R[X_1,\cdots,X_n]\]
such that:
\[\Spec(R[X_1,\cdots,X_n]/P)\] 
is smooth. Then for all $x:R^n$ such that $P(x)=0$ and $k>1$, we have that:
\[N_{k-1}(P) : N_{k-1}(x) \to N_{k-1}(0)\]
being zero implies that:
\[N_{k}(P) : N_{k}(x) \to N_{k}(0)\]
is zero as well.
\end{lemma}

\begin{proof}
Assume given $x:R^n$ such that $P(x)=0$, using a translation we can assume $x=0$. Then:
\[N_{k-1}(P) = 0\]
means that $P=0$ modulo $(X_1,\cdots,X_n)^k$.

Assume given $\epsilon_1,\cdots,\epsilon_n:R$ such that:
\[(\epsilon_1,\cdots,\epsilon_n)^{k+1}=0\]
then we consider the lift in:
 \begin{center}
      \begin{tikzcd}
      R/(\epsilon_1,\cdots,\epsilon_n)^k & R[X_1,\cdots,X_n]/P\ar[l,swap,"X_i\mapsto \epsilon_i"]\ar[ld,dotted]\\
      R\ar[u] &
      \end{tikzcd}
    \end{center} 
    which gives $\delta_1,\cdots,\delta_n: (\epsilon_1,\cdots,\epsilon_n)^k$ such that:
    \[P(\epsilon_1+\delta_1,\cdots,\epsilon_n+\delta_n) = 0\]
    Since $P=0$ modulo $(X_1,\cdots,X_n)^k$, we have:
\[P = \sum_{i_1,\cdots,i_k} c_{i_1,\cdots,i_k} X_{i_1}\cdots X_{i_k} + Q\]
where $Q=0$ modulo $(X_1,\cdots,X_n)^{k+1}$. By computation we get:
   \[\sum_{i_1,\cdots,i_k} c_{i_1,\cdots,i_k} \epsilon_{i_1}\cdots \epsilon_{i_k} = 0\]
   
   So we know that:
   \[(\epsilon_1,\cdots,\epsilon_n)^{k+1}=0\]
   implies:
   \[\sum_{i_1,\cdots,i_k} c_{i_1,\cdots,i_k} \epsilon_{i_1}\cdots \epsilon_{i_k} = 0\]
   so by sqc we can conclude that all $c_{i_1,\cdots,i_k}$ are zeros, so that $P = 0$ modulo $(X_1,\cdots,X_n)^{k+1}$, which indeed means $N_k(P)=0$.
\end{proof}

\begin{lemma}
Assume given $P:R[X_1,\cdots,X_n]$ such that:
\[\Spec(R[X_1,\cdots,X_n]/P)\]
is smooth and $P\not=0$. Then for all $x:R^n$ the jacobian:
\[J(P)(x) : R^n \to R\]
is surjective.
\end{lemma}

\begin{proof}
Since the jacobian is linear and takes value in $R$, it is enough to prove that it is not equal to zero to conclude that it is surjective. But we have an equivalence:
\[(N_1(x)\to N_1(0)) \simeq \mathrm{Hom}_R(T_x(R^n),T_0(R))\]
sending $N_1(P)$ to $J(P)(x)$ so it is enough to prove that $N_1(P)\not=0$. 

Assume $N_1(P)=0$, then by \cref{order-smooth-add-one} we have $N_k(P)=0$ for all $k$ and then $P=0$, which is a contradiction.
\end{proof}

\begin{remark}
Expecting a full converse is unreasonable, see for example:
\[\Spec(R[X]/ (X-a)(X-b),(X-a)(X-c))\]
which is the point whenever $b\not=c$, so that it is smooth, but has its jacobian going from $R$ to $R^2$ so never surjective.
\end{remark}

\subsection{Smooth schemes have free tangent spaces}

\begin{lemma}\label{smooth-implies-smooth-tangent}
Assume $X$ is a smooth scheme. Then for any $x:X$ the type $T_x(X)$ is formally smooth.
\end{lemma}

\begin{proof}
Consider $T(X) = X^{\mathbb{D}(1)}$ the total tangent bundle of $X$. We have to prove that the map:
\[p:T(X)\to X\]
is formally smooth. Both source and target are schemes, and the source is formally smooth because $X$ is smooth and $\mathbb{D}(1)$ has choice. So by \cref{smooth-schemes-iff-submersion} it is enough to prove that for all $x:X$ and $v:T_x(X)$ the induced map:
\[dp:T_{(x,v)}(T(X))\to T_x(X)\]
is surjective. 

Consider $v':T_x(X)$. By unpacking the definition of tangent spaces, we see that merely finding $w:T_{(x,v)}(T(X))$ such that $dp(w) = v'$ means merely finding:
\[\phi : \mathbb{D}(1) \times \mathbb{D}(1) \to X\]
such that for all $t:\mathbb{D}(1)$ we have that:
\[\phi(0,t) = v(t)\]
\[\phi(t,0) = v'(t)\]

But we know that there exists a unique:
\[\psi : \mathbb{D}(2)\to X\]
such that:
\[\psi(0,t) = v(t)\]
\[\psi(t,0) = v'(t)\]
used for example to define $(v+w)(t) = \psi(t,t)$.

Then the fact that $X$ is smooth and that:
\[\mathbb{D}(2) \to\mathbb{D}(1) \times \mathbb{D}(1) \]
is a closed dense embedding means that there merely exists a lift of $\psi$ to $\mathbb{D}(1) \times \mathbb{D}(1)$, which gives us the $\phi$ we wanted.
\end{proof}

\begin{lemma}\label{smooth-kernel-decidable}
Assume given a linear map:
\[M:R^m\to R^n\] 
which has a formally smooth kernel. Then we can decide whether $M=0$.
\end{lemma}

\begin{proof}
Since $M=0$ is closed, it is enough to prove that it is $\neg\neg$-stable to conclude that it is decidable. Assume $\neg\neg(M=0)$, then for any $x:R^m$ we have a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        M=0\ar[d] \ar[r,"\_\mapsto x"] & K \\
       1 \ar[dotted,ru] &
      \end{tikzcd}
\end{center}
because $K$ is formally smooth, so that we merely have $y:K$ such that: 
\[M=0\to x=y\]
which implies that $\neg\neg(x=y)$ since we assumed $\neg\neg(M=0)$.

Then considering a basis $(x_1,\cdots,x_n)$ of $R^m$, we get $(y_1,\cdots,y_n)$ such that for all $i$ we have that $M(y_i) = 0$ and $\neg\neg(y_i=x_i)$. But then we have that $(y_1,\cdots,y_n)$ is infinitesimally close to a basis and that being a basis is an open proposition, so that $(y_1,\cdots,y_n)$ is a basis and $M=0$.
\end{proof}

\begin{lemma}\label{smooth-corpresented-implies-free}
Assume that $K$ is a finitely copresented module that is also formally smooth. Then it is finite free.
\end{lemma}

\begin{proof}
Assume a finite copresentation:
\[0\to K\to R^m\overset{M}{\to} R^n\]
We proceed by induction on $m$. By \cref{smooth-kernel-decidable} we can decide whether $M=0$ or not.
\begin{itemize}
\item If $M=0$ then $K=R^m$ and we can conclude.
\item If $M\not=0$ then we can find a non-zero coefficient in the matrix corresponding to $M$, and so up to base change it is of the form:

\[
\begin{pmatrix}
1 & \begin{matrix}0&\cdots & 0\end{matrix}  \\
\begin{matrix}0\\ \vdots\\ 0\end{matrix} & \widetilde{M} \\
\end{pmatrix}
\]

But then we know that the kernel of $M$ is equivalent to the kernel of $\widetilde{M}$, and by applying the induction hypothesis we can conclude that it is finite free.
\end{itemize}
\end{proof}

\begin{proposition}\label{smooth-have-free-tangent}
Let $X$ be a smooth scheme. Then for any $x:X$ we have that $T_x(X)$ is finite free.
\end{proposition}

\begin{proof}
By \cref{smooth-implies-smooth-tangent} we have that $T_x(X)$ is formally smooth, so that we can conclude by \cref{smooth-corpresented-implies-free}.
\end{proof}

The dimension of $T_x(X)$ is called the dimension of $X$ at $x$.

\begin{corollary}
Any smooth scheme is a finite disjoint union of component of fixed dimension.
\end{corollary}

\subsection{Smooth schemes are locally standard}

\begin{definition}
A standard smooth scheme is an affine scheme of the form:
\[\Spec\big((R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n)_G\big)\]
where $G$ divides the determinant of:
\[\left( \frac{\partial P_i}{\partial X_j}\right)_{1\leq i,j\leq n}\]
in:
\[R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n\]
\end{definition}

\begin{lemma}\label{standard-smooth-etale-over-A}
For any standard smooth scheme:
\[\Spec\big((R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n)_G\big)\]
the map:
\[\Spec\big((R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n)_G\big) \to \Spec(R[Y_1,\cdots Y_{k}])\]
is formally étale.
\end{lemma}

\begin{proof}
The fibers of this map are standard étale, so we can conclude by \cref{standard-etale-are-etale}.
\end{proof}

\begin{corollary}
A standard smooth scheme:
\[\Spec((R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n)_G)\]
is smooth of dimension $k$.
\end{corollary}

\begin{proposition}\label{smooth-are-locally-standard}
A scheme is smooth if and only if it has a Zariski cover by standard smooth schemes.
\end{proposition}

\begin{proof}
We can assume the scheme $X$ affine, say of the form:
\[X = \Spec(R[X_1,\cdots,X_m]/P_1,\cdots,P_l)\]

By \cref{smooth-have-free-tangent}, for any $x:X$ we have that $dP_x$ has free kernel. We partition by the dimension $n$ of the kernel. Then by \cref{rank-equivalent-definitions} we know that $dP_x$ has rank $n$ for every $x$.

We cover $X$ according to which $n$-minor is invertible, so that up to a rearranging of variables and polynomials we can assume that:
\[X = \Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n,Q_1,\cdots, Q_l)\]
where we have:
\[dP_{x,y} = \begin{pmatrix}
\left(\frac{\partial P}{\partial X}\right)_{x,y} & \left(\frac{\partial P}{\partial Y}\right)_{x,y} \\
\left(\frac{\partial Q}{\partial X}\right)_{x,y} & \left(\frac{\partial Q}{\partial Y}\right)_{x,y} \\
\end{pmatrix}\]
where we used the notation:
\[\left(\frac{\partial P}{\partial X}\right)_{x,y} = \begin{pmatrix}\left(\frac{\partial P_i}{\partial X_j}\right)_{x,y}\end{pmatrix}_{i,j}\]
so that $\frac{\partial P}{\partial X}$ is invertible of size $n$. Moreover by \cref{rank-bloc-matrix} we get:
\[\left(\frac{\partial Q}{\partial Y}\right)_{x,y} = \left(\frac{\partial Q}{\partial X}\right)_{x,y}\left(\frac{\partial P}{\partial X}\right)_{x,y}^{-1} \left(\frac{\partial P}{\partial Y}\right)_{x,y} \]
which will be useful later.

Now we prove that for any $(x,y):R^{n+k}$ such that $P(x,y)=0$ it is decidable whether
\[Q(x,y)=0 \] 
To do this it is enough to prove that:
\[(Q_1(x,y),\cdots,Q_l(x,y))^2=0 \to (Q_1(x,y),\cdots,Q_l(x,y))=0\]
Assuming $(Q_1(x,y),\cdots,Q_l(x,y))^2=0$, by smoothness there is a dotted lifting in:
 \begin{center}
      \begin{tikzcd}
        R/(Q_1(x,y),\cdots,Q_l(x,y)) & \Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n,Q_1,\cdots, Q_l)\ar[l,swap,"(x{,}y)"] \ar[dotted,ld,"(x{'}{,}y{'})"]\\
       R\ar[u] & \\
      \end{tikzcd}
\end{center}
Let us prove that $Q(x,y) = 0$. Indeed we have $(x,y) \sim_1 (x',y')$ so that we have:
\[P(x,y) = P(x',y')+ \left(\frac{\partial P}{\partial X}\right)_{x',y'}(x-x') + \left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y') \]
\[Q(x,y) = Q(x',y')+ \left(\frac{\partial Q}{\partial X}\right)_{x',y'}(x-x') + \left(\frac{\partial Q}{\partial Y}\right)_{x',y'}(y-y') \]
Then we have $P(x,y) = 0$, $P(x',y')=0$ and $Q(x',y') = 0$. From the first equality we get:
\[x-x' =  -\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1}\left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y')\]
so that from the second we get:
\[Q(x,y) = -\left(\frac{\partial Q}{\partial X}\right)_{x',y'}\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1}\left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y') + \left(\frac{\partial Q}{\partial Y}\right)_{x',y'}(y-y')\]
so that $Q(x,y)=0$ as we have seen previously that:
\[\left(\frac{\partial Q}{\partial Y}\right)_{x',y'} = \left(\frac{\partial Q}{\partial X}\right)_{x',y'}\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1} \left(\frac{\partial P}{\partial Y}\right)_{x',y'} \]

From the decidability of $Q(x,y)=0$ we get that $X$ is an open in:
\[\Spec(R[X_1,\cdots,X_n,Y_1,\cdots,Y_k]/P_1,\cdots,P_n)\]
and from there we conclude exactly as in \cref{etale-are-locally-standard}.
\end{proof}

The following definition is reasonable from a synthetic differential geometry standpoint:

\begin{definition}
A type $X$ is called a manifold of dimension $k$ if there merely is a span:
 \begin{center}
      \begin{tikzcd}
         &  U\ar[dl,swap,"p"]\ar[dr,"q"]& \\
      \A^k & & X \\
      \end{tikzcd}
\end{center}
where $p$ and $q$ are formally étale and $q$ is surjective.
\end{definition}

\begin{proposition}\label{smooth-scheme-manifold}
Given a scheme $X$ the following are equivalent:
\begin{itemize}
\item The scheme $X$ is formally smooth of dimension $k$.
\item The scheme $X$ is a manifold of dimension $k$.
\end{itemize}
\end{proposition}

\begin{proof}
The fact that $k$-manifolds are smooth is immediate, as in the span:
 \begin{center}
      \begin{tikzcd}
         &  U\ar[dl,swap,"p"]\ar[dr,"q"]& \\
      \A^k & & X \\
      \end{tikzcd}
\end{center}
we have that $\A^k$ smooth and $p$ étale implies $U$ smooth by \cref{smooth-sigma-closed},
and then $q$ surjective implies $X$ smooth by \cref{smoothSurjective}. To know that $X$ is of dimension $k$ we use that any étale map induces isomorphisms of tangent spaces plus surjectivity.

For the converse we use \cref{smooth-are-locally-standard} and \cref{standard-smooth-etale-over-A}.
\end{proof}

