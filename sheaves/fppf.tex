This section is concerned with fppf sheaves in the Zariski topos.

\subsection{Definition}

\begin{definition}
The fppf topology is the topology generated by $\Spec(R[X]/g)$ for all monic $g:R[X]$.
\end{definition}

\begin{example}
Finite types are fppf sheaves.
\end{example}

\subsection{Schemes are fppf sheaves}

\begin{lemma}\label{fppf-subcanonical}
The type $R$ is an fppf sheaf. In other words, the fppf topology is subcanonical.
\end{lemma}

\begin{proof}
Using \cref{set-sheaves-condition} we just need to prove that the map from $R$ to the equaliser of:
\[R[X]/g \rightrightarrows R[X]/g \otimes R[X]/g\]
is an equivalence. But since $g$ is monic we merely have:
\[R[X]/g \simeq R^n\]
and then we check that the induced map from $R$ to the equaliser of:
\[R^n \rightrightarrows R^n\otimes R^n\]
is an equivalence.
\end{proof}

\begin{corollary}
Any affine scheme is a fppf sheaf. Any f.p. $R$-algebra is an fppf sheaf.
\end{corollary}

\begin{lemma}\label{scheme-are-sheaf-from-affine}
Assume given a type $P$ such that:
\begin{itemize}
\item The type $R$ is $P$-local.
\item The type of open propositions is $P$-smooth.
\end{itemize}
Then any scheme is $P$-local.
\end{lemma}

\begin{proof}
Since $R$ is $P$-local we see that all affine schemes are $P$-local through stability under dependent products and identity types.

We check that any scheme $X$ is $P$-smooth. Assume given constant map:
\[f:P\to X\]
Take $(U_i)_{i:I}$ a finite cover of $X$ by affine scheme. Then for any $i:I$ we have that $f^{-1}(U_i)$ is a constant open in $P$, so since the type of open is $P$-smooth, we merely have an open proposition $V_i$ such that for all $x:P$, we have:
\[(x\in f^{-1}(U_i) )\leftrightarrow V_i\]
Since the $f^{-1}(U_i)$ cover $P$, we have that:
\[P\to \lor_{i:I} V_i\]
But open propositions are affine schemes and affine schemes are $P$-local, so we have:
\[ \lor_{i:I} V_i\]
Assume $k:I$ such that $V_k$ holds. Then $f^{-1}(U_k) = P$ and the map $f$ factors through the affine scheme $U_k$. Since affine schemes are $P$-local, we merely have a lift for $f$.

Now we conclude that any scheme is $P$-local by proving that its identity types are $P$-local. Indeed they are propositional schemes, so they are $P$-smooth propositions, so they are $P$-local.
\end{proof}

\begin{lemma}\label{roots-monic-proper}
For any monic $g:R[X]$, we have that $\Spec(R[X]/g)$ is projective. In particular it is compact, meaning that for any open $U$ in $\Spec(R[X]/g)$ the proposition:
\[\prod_{x:\Spec(R[X]/g)}U(x)\]
is open.
\end{lemma}

\begin{proof}
Assume that:
\[g=X^n+a_{n-1}X^{n-1}+\cdots+a_0\]
Then we consider the homogeneous polynomial:
\[f(X,Y) = X^n + a_{n-1}X^{n-1}Y+\cdots+a_0Y^n\]
We prove that:
\[\sum_{[x,y]:\bP^1}f(x,y) = 0\]
is equivalent to $\Spec(R[X]/g)$. Indeed for any $x,y:R$ such that $f(x,y)=0$, we have that $x\not=0$ implies $y\not=0$, so that $(x,y)\not=0$ implies $y\not=0$. Then:
\[\sum_{[x,y]:\bP^1}f(x,y) = 0\]
is equivalent to:
\[\sum_{x:R} f(x,1)=0\]
which is the type of roots of $g$. 

Now we conclude using the fact that 
\[\sum_{[x,y]:\bP^1}f(x,y) = 0\]
is closed in the compact scheme $\bP^1$, so that it is compact.
\end{proof}

\begin{proposition}\label{schemes-are-fppf-sheaves}
Any scheme is an fppf sheaf.
\end{proposition}

\begin{proof}
Assume given $g:R[X]$ monic, by \cref{scheme-are-sheaf-from-affine} it is enough to prove that $R$ is $\propTrunc{\Spec(R[X]/g)}$-local (this is \cref{fppf-subcanonical}) and that the type of open propositions is $\propTrunc{\Spec(R[X]/g)}$-smooth. 

Assume given a constant open $D(h_1,\cdots,h_n)$ in $\Spec(R[X]/g)$. Then for any $x:\Spec(R[X]/g)$ we have that:
\[x\in D(h_1,\cdots,h_n) \leftrightarrow \prod_{y:\Spec(R[X]/g)} y\in D(h_1,\cdots,h_n)\]
because the open $D(h_1,\cdots,h_n)$ is constant. But the right hand side is open by \cref{roots-monic-proper}, so we indeed have a lift.
\end{proof}

\subsection{Fppf covers are flat}

\begin{definition}
A map between affine schemes:
\[\Spec(B)\to \Spec(A)\]
is flat if for all injective morphism of $A$-modules: 
\[M\to N\]
the induced map:
\[B\otimes_A M \to B\otimes_A N\]
is injective.
\end{definition}

\begin{lemma}\label{root-monic-flat}
Assume a f.p. $R$-algebra $A$ and $g:A[X]$ monic, then the induced map:
\[\Spec(A[X]/g)\to \Spec(A)\]
is flat.
\end{lemma}

\begin{proof}
Since $g$ is monic we have:
\[A[X]/g\simeq A^n\]
as $A$-modules. Then given an injective map of $A$-modules:
\[f:M\to N\]
the induced map;
\[A[X]/g\otimes_AM \to A[X]/g\otimes_AN\]
is of the form:
\[f^n:M^n\to N^n\]
which is injective.
\end{proof}

\begin{lemma}\label{localisation-is-flat}
For any f.p. $R$-algebra $A$ and any $f:A$, the map:
\[\Spec(A_f)\to\Spec(A)\]
is flat.
\end{lemma}

\begin{proof}
Assume given an injective map of $A$-modules:
\[g:M\to N\]
Assume given:
\[\frac{m}{f^i},\frac{n}{f^j}\]
in $A_f\otimes_AM$ such that:
\[g(\frac{m}{f^i}) = g(\frac{n}{f^j})\]
in $A_f\otimes_AN$. Then there is $k$ such that:
\[f^{j+k}g(m) = f^{i+k}g(n)\]
in $N$. But then since $g$ is $A$-linear we have:
\[g(f^{j+k}m) = g(f^{i+k}n)\]
in $N$, so from injectivity of $g$ we conclude:
\[f^{j+k}m = f^{i+k}n\]
which implies that:
\[\frac{m}{f^i} = \frac{n}{f^j}\]
in $A_f\otimes_AM$.
\end{proof}

We have a kind of converse:

\begin{lemma}\label{injectivity-is-zariski-local}
Let $A$ be a f.p. $R$ algebra and $f_1,\cdots,f_n:A$ such that $(f_1,\cdots,f_n) = A$ . Assume given a map between between $A$-modules:
\[g:M\to N\] 
such that for all $i$ the induced map:
\[A_{f_i}\otimes_AM \to A_{f_i}\otimes_AN\]
is injective. Then $g$ is injective.
\end{lemma}

\begin{proof}
Assume $m$ in $M$ such that $g(m)=0$ in $N$. Then $g(m) =0$ in $A_{f_i}\otimes_AN$ so by the assumed injectivity we have $m=0$ in $A_{f_i}\otimes_AM$ for all $i$.

This means that for all $i$ we have $k_i:\N$ such that $f_i^{k_i}m = 0$ in $M$. But then since the $D(f_i^{k_i})$ cover $\Spec(A)$ we know that $(f_1^{k_1},\cdots,f_n^{k_n}) = A$ and we can conclude that $m=0$ in $M$ as we needed.
\end{proof}

\begin{lemma}\label{flat-zariski-local}
Being flat is Zariski-local in the target. More precisely assume given a map between affine schemes:
\[f:\Spec(B)\to \Spec(A)\]
and a Zariski cover $(U_i)_{i:I}$ of $\Spec(A)$. If for all $i:I$ the map:
\[f : f^{-1}(U_i)\to U_i\]
is flat, then the map $f$ is flat.
\end{lemma}

\begin{proof}
Assume an injective map betweem f.p. $A$-module:
\[M\to N\]
For all $i$ we have an injective map between f.p. $A_{f_i}$-module:
\[A_{f_i}\otimes_AM\to A_{f_i}\otimes_AN\]
because localisation is flat by \cref{localisation-is-flat}. Since:
\[\Spec(B\otimes_AA_{f_i})\to \Spec(A_{f_i})\]
is flat, we know that:
\[A_{f_i}\otimes_AB\otimes_AM\to A_{f_i}\otimes_AB\otimes_AN\]
is injective for all $i$, and from \cref{injectivity-is-zariski-local} we conclude that the map:
\[B\otimes_AM\to B\otimes_AN\]
is injective.
\end{proof}

\begin{lemma}\label{cover-is-flat}
Any fppf cover is flat.
\end{lemma}

\begin{proof}
We proceed by induction on the fppf cover:
\begin{itemize}
\item If the fppf cover is an identity or a composite of fppf cover, we just need to check that identity maps are flat and that flat maps are stable under composition.
\item If the fppf cover is Zariski-locally an fppf cover we use \cref{flat-zariski-local}.
\item If the fppf cover has fibers of the form $\Spec(R[x]/g)$ with $g$ monic, then we know that it is Zariski-locally of the form:
\[\Spec(B[X]/f)\to \Spec(B)\]
with $f$ monic and we conclude by \cref{flat-zariski-local} and \cref{root-monic-flat}.
\end{itemize}
\end{proof}

\subsection{Fppf covers are faithfully flat}

\begin{definition}
A map between affine schemes:
\[\Spec(B)\to \Spec(A)\]
is faithfully flat if it is flat and for all $A$-module $M$ we have that $B\otimes_AM = 0$ implies $M=0$.
\end{definition}

\begin{lemma}\label{root-monic-faithfully-flat}
Assume a f.p. $R$-algebra $A$ and $g:A[X]$ monic, then the induced map:
\[\Spec(A[X]/g)\to \Spec(A)\]
is faithfully flat.
\end{lemma}

\begin{proof}
It is flat by \cref{root-monic-flat}. Assume $M$ an $A$-module such that:
\[ A[X]/g\otimes_AM = 0\]
then since $A[X]/g = A^n$ as $A$-modules we have $M^n = 0$ so that $M=0$.
\end{proof}

\begin{lemma}\label{pullback-faitfully-flat}
Assume given a pullback square of affine schemes:
 \begin{center}
      \begin{tikzcd}
        \Spec(B\otimes_AC)\ar[d,swap,"g"]\ar[r]& \Spec(B)\ar[d,"f"] \\
       \Spec(C) \ar[r]& \Spec(A)
      \end{tikzcd}
    \end{center}
If $f$ is flat so is $g$. If $f$ is faithfully flat so is $g$.
\end{lemma}

\begin{proof}
Assume $f$ flat. Then for all injective map of $C$-modules:
\[M\to N\]
we have that:
\[B\otimes_A M \to B\otimes_A N\]
so that:
\[M\to N\]
is injective as a map of $A$-modules, so it is injective as a map of $C$-modules as well.

Now assume $f$ faithfully flat. If $M$ is a $C$-module such that:
\[B\otimes_A C\otimes M = 0\]
i.e. $B\otimes_A M = 0$, then $M=0$ as an $A$-module, so $M=0$ as a $C$-module.
\end{proof}

\begin{lemma}\label{faithfully-flat-zariski-local}
Being faithfully flat is Zariski-local in the target. More precisely assume given a map between affine schemes:
\[f:\Spec(B)\to \Spec(A)\]
and a Zariski cover $(U_i)_{i:I}$ of $\Spec(A)$. If for all $i:I$ the map:
\[f : f^{-1}(U_i)\to U_i\]
is faithfully flat, then the map $f$ is faithfully flat.
\end{lemma}

\begin{proof}
The map is flat by \cref{flat-zariski-local}. Now assume an $A$-module $M$ such that $B\otimes_AM=0$. Up to refinement, using \cref{pullback-faitfully-flat}, we can assume that $U_i = D(f_i)$ for all $i$, with the $f_i$ generating $A$. Then we have:
\[B\otimes_AA_{f_i}\otimes_{A_{f_i}}A_{f_i}\otimes M = 0\]
so that since by hypothesis:
\[\Spec(B\otimes_AA_{f_i}) \to \Spec(A_{f_i})\]
is faithfully flat, for all $i$ we have that:
\[A_{f_i}\otimes_A M = 0\]
Then we conclude using \cref{injectivity-is-zariski-local} on the map $M\to 0$, concluding that it is injective so that $M=0$.
\end{proof}

\begin{proposition}\label{cover-is-faithfully-flat}
Any fppf cover is faithfully flat.
\end{proposition}

\begin{proof}
It is flat by \cref{cover-is-flat}. The rest the proof for faithfulness is very similar. More precisely, to see that it is faithfully flat we proceed by induction on the fppf cover:
\begin{itemize}
\item If the fppf cover is an identity or a composite of fppf cover, we just need to check that identity maps are faithfully flat and that faithfully flat maps are stable under composition.
\item If the fppf cover is Zariski-locally an fppf cover we use \cref{faithfully-flat-zariski-local}.
\item If the fppf cover has fibers of the form $\Spec(R[x]/g)$ with $g$ monic, then we know that it is Zariski-locally of the form:
\[\Spec(B[X]/f)\to \Spec(B)\]
with $f$ monic and we conclude by \cref{faithfully-flat-zariski-local} and \cref{root-monic-faithfully-flat}.
\end{itemize}
\end{proof}

\begin{lemma}\label{faithfully-flat-choice}
Assume an affine scheme $\Spec(A)$ with a family of types $P(x)$ for $x:\Spec(A)$ such that:
\[\prod_{x:\Spec(A)}L_{fppf}\propTrunc{P(x)}\]
Then there merely exists a faithfully flat map:
\[f:\Spec(B)\to\Spec(A)\]
such that:
\[\prod_{x:\Spec(B)}P(f(x))\]
\end{lemma}

\begin{proof}
By \cref{cover-local-choice} there exists an such an $f$ that is an fppf cover. We conclude by \cref{cover-is-faithfully-flat}.
\end{proof}

\begin{proposition}
Any flat and fppf surjective map between affine schemes is faithfully flat.
\end{proposition}

\begin{proof}
We have an fppf surjective map:
\[f:\Spec(B)\to \Spec(A)\]
meaning that:
\[\prod_{x:\Spec(A)}L_{fppf}\propTrunc{\mathrm{fib}_f(x)}\]
Then by \cref{faithfully-flat-choice} we have a commutative diagram:
 \begin{center}
      \begin{tikzcd}
        & \Spec(B)\ar[d,"f"] \\
       \Spec(C)\ar[ru] \ar[r,swap,"g"] & \Spec(A)git 
      \end{tikzcd}
    \end{center}
where $g$ is faithfully flat. It is easy to conclude from this.
\end{proof}

\subsection{The fppf sheaf model TODO}

Some work need to be done on interpretation of statement into modal types (for a lex modality).

\begin{theorem}
The following holds when interpreted in fppf sheaves:
\begin{enumerate}[(i)]
\item The ring $R$ is local, and any monic polynomial in $R$ merely has a root.
\item Synthetic quasi coherence.
\item Affine schemes enjoys flat local choice, meaning that given TODO
\end{enumerate}
\end{theorem}

\begin{proof}
TODO
\end{proof}


