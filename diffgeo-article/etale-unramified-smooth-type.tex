In this section we will give our new synthetic definitions of formally étale, formally unramified and formally smooth types and maps. It is remarkable that these definitions work for any type or map rather than just scheme and map between them. Here we will derive consequences of these definition applicable for all types, as well as compare these definitions to the traditional ones.

\subsection{Definitions}

In \cite{draft} it is shown that elements of the base ring $R$ are nilpotent if and only if they are not not zero.
Both nilpotency and double negated equality have been used to describe infinitesimals and the following closed dense propositions can be viewed as closed subspaces of the point which are infinitesimally close to being the whole point:

\begin{definition}
A closed proposition is dense\index{closed dense proposition} if it is merely of the form:
\[r_1=0\land\cdots\land r_n=0\]
with $r_1,\cdots,r_n:R$ nilpotent.
\end{definition}

\begin{remark}
A closed proposition $P$ is closed dense if and only if $\neg\neg P$.
\end{remark}

From a traditional perspective, the inclusion $P\subseteq 1$ of a closed dense proposition into the point would be an infinitesimal extension.
In the following, we will use closed dense propositions to define synthetic analogs of notions which are traditionally defined using lifting properties against classes of infinitesimal extensions.
More details on the connection to traditional definitions will be given in \Cref{connection-to-ega-definition}.

\begin{definition}
  \label{def-etale-closed-dense}
A type $X$ is formally étale (resp. formally unramified, formally smooth)\index{formally étale}\index{formally unramified}\index{formally smooth} if for all closed dense proposition $P$ the map:
\[X\to X^P\]
is an equivalence (resp. an embedding, surjective).
\end{definition}

\begin{remark}
The map $X\to X^P$ is an equivalence (resp. an embedding, surjective) if and only if for any map $P\to X$ we have a unique (resp. at most one, merely one) dotted lift in:
\begin{center}
\begin{tikzcd}
P\ar[r]\ar[d] & X\\
1\ar[ru,dashed]& \\
\end{tikzcd}
\end{center}
\end{remark}

\begin{definition}
A map is said to be formally étale (resp. formally unramified, formally smooth) if its fibers are formally étale (resp. formally unramified, formally smooth).
\end{definition}

\begin{remark}
A type (or map) is formally étale if and only if it is formally unramified and formally smooth.
\end{remark}

\begin{lemma}\label{etale-unramified-smooth-square-zero}
A type $X$ is formally étale (resp. formally unramified, formally smooth) if and only if for all $\epsilon:R$ such that $\epsilon^2=0$, the map:
\[X\to X^{\epsilon=0}\]
is an equivalence (resp. an embedding, surjective).
\end{lemma}

\begin{proof}
The direct direction is obvious as $\epsilon=0$ is closed dense when $\epsilon^2=0$.

For the converse, assume $P=\Spec(R/N)$ a closed dense proposition. Then the map $R\to R/N$ with $N$ finitely generated nilpotent ideal can be decomposed as:
\[R\to A_1\to \cdots A_n = R/N\]
where $A_k$ is a quotient of $R$ by a finitely generated nilpotent ideal and:
\[A_k\to A_{k+1}\]
is of the form:
\[A\to A/(a)\]
for some $a:A$ with $a^2=0$.

We write $P_k = \Spec(A_k)$ and:
\[i_k:P_{k+1}\to P_k\] 
so that $\mathrm{fib}_{i_k}(x)$ is $a(x)=0$ where $a(x)^2=0$ holds.

Then by hypothesis we have that for all $k$ and $x:P_{k}$ the map:
\[X\to X^{\mathrm{fib}_{i_k}(x)}\]
is an equivalence (resp. an embedding, surjective). So the map:
\[X^{P_{k}} \to \prod_{x:P_{k}}X^{\mathrm{fib}_{i_k}(x)} = X^{P_{k+1}}\]
is an equivalence (resp. an embedding, surjective, where surjectivity uses $P_{k}$ having choice).
We conclude that the map:
\[X\to X^P\]
is an equivalence (resp. an embedding, surjective).
\end{proof}



\subsection{Stability results}

Being formally étale is a modality given as nullification at all dense closed propostions and therefore lex \cite[Corollary 3.12]{modalities}.
This means that we have the following:

\begin{proposition}
Formally étale types enjoy the following stability results:
\begin{itemize}
\item If $X$ is any type and for all $x:X$ we have $Y_x$ formally étale, then $\prod_{x:X}Y_x$ is formally étale. 
\item  If $X$ is formally étale and for all $x:X$ we have $Y_x$ formally étale, then $\sum_{x:X}Y_x$ is formally étale. 
\item If $X$ is formally étale then for all $x,y : X$ the type $x=y$ is formally étale.
\item The type of formally étale types is itself formally étale.
\end{itemize}
\end{proposition}

Formally unramified type are the separated types \cite[Definition 2.13]{localization} associated to formally étale types. This means:

\begin{lemma}
A type $X$ is formally unramified if and only if for all $x,y:X$ the type $x=y$ is formally étale.
\end{lemma}

By \cite[Lemma 2.15]{localization}, being formally unramified is a nullification modality as well. This means we have the following:

\begin{proposition}
Formally unramified types enjoy the following stability results:
\begin{itemize}
\item If $X$ is any type and for all $x:X$ we have $Y_x$ formally unramified, then $\prod_{x:X}Y_x$ is formally unramified. 
\item If $X$ is formally unramified and for all $x:X$ we have $Y_x$ formally unramified, then $\sum_{x:X}Y_x$ is formally unramified.
\end{itemize}
\end{proposition}

Being formally smooth is not a modality, indeed we will see it is not stable under identity types. Neverthless we have the following results:

\begin{lemma}\label{smooth-sigma-closed}
Formally smooth types enjoy the following stability results:
\begin{itemize}
\item If $X$ is any type satifying choice and for all $x:X$ we have $Y_x$ formally smooth, then $\prod_{x:X}Y_x$ is formally smooth.
\item If $X$ is a formally smooth type and for all $x:X$ we have $Y_x$ formally smooth, then $\sum_{x:X}Y_x$ is formally smooth.
\end{itemize}
\end{lemma}


\subsection{Type-theoretic examples}

The next proposition implies that open propositions, and therefore open embeddings, are formally étale.

\begin{lemma}\label{not-not-stable-prop-etale}
  Any $\neg\neg$-stable proposition is formally étale.
\end{lemma}

\begin{proof}
  Assume $U$ is a $\neg\neg$-stable proposition. For $U$ to be formally étale it is enough to check that $U^P\to U$ for all $P$ closed dense. This holds because for $P$ closed dense we have $\neg\neg P$.
  \end{proof}

Before proving the next lemma about closed formally étale propositions,
we will state and prove a general fact about closed propositions:

\begin{lemma}
  \label{square-zero-implies-zero-decidable}
  Let $I$ be a finitely generated ideal of $R$ such that $I^2=0$ implies $I=0$.
  Then the closed proposition $I=0$ is decidable.
\end{lemma}

\begin{proof}
  Let $I\subseteq R$ be a finitely generated ideal such that $I^2=0$ implies $I=0$.
  Since the other implication always holds, the propositions $I^2=0$ and $I=0$ are equivalent, so we have $I=I^2$.
  By Nakayama (see \cite[Lemma II.4.6]{lombardi-quitte}) there exists $e:R$ such that $eI = 0$ and $1-e\in I$.
  If $e$ is invertible then $I=0$, if $1-e$ in invertible then $I=R$.
\end{proof}

\begin{lemma}\label{closed-and-etale-decidable}
Any formally étale closed proposition is decidable.
\end{lemma} 

\begin{proof}
Given a formally étale closed proposition $P$, let us prove it is $\neg\neg$-stable. Indeed if $\neg\neg P$ then $P$ is closed dense so that $P\to P$ implies $P$ since $P$ is formally étale. 

Let $I$ be the finitely generated ideal in $R$ such that:
\[P\leftrightarrow I=0\]
We have that $I^2=0$ implies $\neg\neg (I=0)$ which implies $I=0$.
Then $P$ is decidable by \Cref{square-zero-implies-zero-decidable}. 
\end{proof}

\begin{proposition}\label{bool-is-etale}
  The type $\Bool$ is formally étale.
\end{proposition}

\begin{proof}
The identity types in $\Bool$ are decidable so $\Bool$ is formally unramified. Consider $\epsilon:R$ such that $\epsilon^2=0$ and a map:
\[\epsilon=0 \to \Bool\]
we want to merely factor it through $1$.

 Since $\Bool\subseteq R$, by duality the map gives $f:R/(\epsilon)$ such that $f^2=f$. Since $R/(\epsilon)$ is local we conclude that $f = 1$ or $f=0$ and so the map has constant value $0:\Bool$ or $1:\Bool$.
\end{proof}

\begin{remark}\label{finite-are-etale}
This means that formally étale (resp. formally unramified, formally smooth) types are stable by finite sums. In particular finite types are formally étale.
\end{remark}

%Not used anywhere, maybe remove TODO?
\begin{proposition}
The type $\N$ is formally étale.
\end{proposition}

\begin{proof}
Identity types in $\N$ are decidable so $\N$ is formally unramified, we want to show it is formally smooth. Assume given a map:
\[P\to \N\]
for $P$ a closed dense proposition, we want to show it merely factors through $1$. By boundedness the map merely factors through a finite type, which is formally étale by \Cref{finite-are-etale} so we can conclude.
\end{proof}

\begin{lemma}\label{prop-are-unramified}
Any proposition is formally unramified.
\end{lemma}

This means that any subtype of a formally unramified type is formally unramified.

\begin{remark}
  Given any lex modality, a type is separated if and only if it is a subtype of a modal type,
  so a type is formally unramified if and only if it is a subtype of a formally étale type.
\end{remark}

We also have the following surprising dual result, meaning that any quotient of a formally smooth type is formally smooth:

\begin{proposition}\label{smoothSurjective}
If $X$ is formally smooth and $p:X\twoheadrightarrow Y$ surjective, then $Y$ is formally smooth.
\end{proposition}

\begin{proof}
For any $P$ closed dense and any map $P\to Y$, consider the diagram:
 \begin{center}
      \begin{tikzcd}
      P \ar[rd,dashed]\ar[d]\ar[r]& Y\\
      1 \ar[r,dashed,swap,"x"]& X\ar[u,swap,"p",two heads]
      \end{tikzcd}
    \end{center} 
    By choice for closed propositions we merely get the dotted diagonal, and since $X$ is formally smooth we get the dotted $x$, and then $p(x)$ gives a lift.
\end{proof}


\subsection{Classical definitions, examples and counter-examples}

In this section we will show that our definition of étale, smooth and unramified maps between schemes is equivalent to the obvious internal version of the traditional definition. It is important to keep in mind that our schemes are always locally of finite presentation, so the following definition is sensible:

\begin{definition}
  An étale (resp.\ unramified, smooth)\index{étale}\index{smooth}\index{unramified} scheme is a scheme which is formally étale (resp.\ formally unramified, formally smooth) as a type.
  An étale (resp.\ unramified, smooth) map is a map between schemes which is formally étale (resp.\ formally unramified, formally smooth).
\end{definition}

A criterion very similar to next remark appears as the definition of a formally étale, unramified and smooth maps in \cite[§17]{EGAIV4},
except we restrict to finitely presented algebras and finitely generated ideals, as our schemes are assumed locally of finite presentation, and we ask the lift for smoothness to exists only \emph{Zariski-locally}, as suggested in \cite[\href{https://stacks.math.columbia.edu/tag/02GZ}{Tag 02GZ}]{stacks-project}.  It is not clear if this internal criterion corresponds to the external definitions.

\begin{remark}
  \label{connection-to-ega-definition}
  Let $f:X\to Y$ be a map between schemes.
  Then $f$ is étale (resp.\ unramified, smooth) if and only if there exists exactly one (resp.\ at most one, at least one \emph{Zariski-locally}) dotted lift in all squares of the form:
  \begin{center}
    \begin{tikzcd}
      \Spec(A/N)\ar[r,"t"]\ar[d] & X\ar[d,"f"] \\
      \Spec(A)\ar[ru,dashed]\ar[r,swap,"b"] & Y
    \end{tikzcd}    
  \end{center}
where $A$ is a finitely presented $R$-algebra, $N$ a finitely generated nilpotent ideal and the left map is induced by the quotient map $A\to A/N$. In the smooth case, we believe that it is possible to prove global existence of these lifts using cohmological methods.
\end{remark}

\begin{proof}
  The inclusion of a closed dense proposition $P$ into $1$ is a special case of left map in the remark, so we only need to show that étale,
  smooth and unramified maps satisfy the more general lifting property. For étale and unramified maps, we can just apply the lifting property for closed dense propositions for all points in $\Spec A$. So let $f:X\to Y$ be smooth. Then we merely have a lift for each point in $\Spec(A)$ and can apply Zariski-local choice to get the desired result.
\end{proof}

We conclude this section with a few examples and counter examples.

\begin{lemma}\label{An-is-smooth}
For all $k:\N$, we have that $\A^k$ is smooth.
\end{lemma}

\begin{proof}
  Let $P$ be a closed dense proposition and $N$ a nilpotent, finitely generated ideal such that $P=\Spec(R/N)$.
  Since $\Spec(R[X_1,\dots,X_k])=\A^k$, to prove $\A^k$ smooth we just need to find dotted lifts in:
  \begin{center}
    \begin{tikzcd}
      R/N & R[X_1,\dots,X_k]\ar[l]\ar[ld,dashed]  \\
      R\ar[u] & 
    \end{tikzcd}
  \end{center}
  This is easy using the universal property of $R[X_1,\dots,X_k]$.
\end{proof}

\begin{example}
The affine scheme $\Spec(R[X]/X^2)$ is not smooth.
\end{example}

\begin{proof}
If it were smooth, then for any $\epsilon$ with $\epsilon^3=0$ we would be able to prove $\epsilon^2=0$.
Indeed we would merely have a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        R/(\epsilon^2)& R[X]/(X^2)\ar[l,swap,"\epsilon"]\ar[ld,dashed] \\
        R \ar[u]& 
      \end{tikzcd}
    \end{center}
    that is, an $r:R$ such that $(\epsilon+r\epsilon^2)^2=0$. Then $\epsilon^2=0$.
\end{proof}

\begin{example}
The affine scheme $\Spec(R[X,Y]/XY)$ is not smooth.
\end{example}

\begin{proof}
Again, we assume a lift for any $\epsilon$ with $\epsilon^3=0$:
 \begin{center}
   \begin{tikzcd}
     R/(\epsilon^2) & R[X,Y]/(XY)\ar[l]\ar[ld,dashed] \\
     R\ar[u] & 
   \end{tikzcd}
 \end{center}
 where the top map sends both $X$ and $Y$ to $\epsilon$. Then we have $r,r':R$ such that $(\epsilon+r\epsilon^2)(\epsilon+r'\epsilon^2)=0$ so that $\epsilon^2=0$.
\end{proof}

We will proof a generalization of the following example in \Cref{standard-etale-are-etale}.
The essential step is to improve a zero $g(y)=0$ up to some square-zero $\epsilon$ to an actual zero.

\begin{example}
Let $g$ be a polynomial in $R[X]$ such that for all $x:R$ we have that $g(x)=0$ implies $g'(x)\not=0$. Then $\Spec(R[X]/g)$ is étale.
\end{example}


\subsection{Being formally étale, unramified or smooth is Zariski local}

\begin{lemma}\label{etale-zariski-local}
Let $X$ be a type with $(U_i)_{i:I}$ a finite open cover of $X$. Then $X$ is formally étale (resp. formally unramified, formally smooth) if and only if all the $U_i$ are formally étale (resp. formally unramified, formally smooth).
\end{lemma}

\begin{proof}
First, we show this for formally unramified:
\begin{itemize}
\item Any subtype of a formally unramified type is formally unramified by \Cref{prop-are-unramified}, so $X$ formally unramified implies $U_i$ formally unramified.
\item Conversely, is each $U_i$ is formally unramified, then for all $x,y:X$ we need to prove $x=_Xy$ formally étale. But there exists $i:I$ such that $x\in U_i$ and then:
\[x=_Xy \leftrightarrow \sum_{y\in U_i} x=_{U_i}y \]
which is formally étale because open propositions are formally étale by \Cref{not-not-stable-prop-etale}.
\end{itemize}
Now for formally smooth:
\begin{itemize}
\item Open propositions are formally smooth by \Cref{not-not-stable-prop-etale} so that open subtypes of formally smooth types are formally smooth.
\item Conversely if each $U_i$ is formally smooth then $\Sigma_{i:I}U_i$ is formally smooth by \Cref{finite-are-etale}, so we can conclude that $X$ is formally smooth by applying \Cref{smoothSurjective} to the surjection $\Sigma_{i:I}U_i \twoheadrightarrow X$.
\end{itemize}
The result for formally étale immediately follows.
\end{proof}

\begin{corollary}
For all $k:\N$, the projective space $\bP^k$ is smooth.
\end{corollary}

\begin{proof}
By \Cref{etale-zariski-local} it is enough to check that $\A^k$ is smooth. This is \Cref{An-is-smooth}
\end{proof}




