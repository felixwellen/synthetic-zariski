In this section we will give characterizations similar to Section \ref{unramified-characterisation} for smooth and étale schemes.

\subsection{Smooth and étale maps between schemes}

Smooth maps between with a smooth smooth source are precisely submersions.

\begin{corollary}\label{smooth-schemes-iff-submersion}
Let $f:X\to Y$ be a map between schemes with $X$ smooth. Then the following are equivalent:
\begin{enumerate}[(i)] 
\item The map $f$ is smooth.
\item For all $x:X$, the induced map:
\[df : T_x(X)\to T_{f(x)}(Y)\]
is surjective.
\end{enumerate}
\end{corollary}

\begin{proof}
(i) implies (ii). Assume given $v:T_{f(x)}(Y)$, then for all $t:\D(1)$ we have a map:
\[t=0 \to \fib_f(v(t))\]
with constant value $x$. So since $f$ is smooth we merely have $w_t:\fib_f(v(t))$ such that $t=0$ implies $w_t=x$. We conclude using choice over $\D(1)$.

(ii) implies (i). Assume given $y:Y$ and $\epsilon:R$ such that $\epsilon^2=0$ and try to merely find a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        \epsilon=0\ar[r,"\phi"]\ar[d] & \fib_f(y)\\
       1 \ar[ru,dashed] & \\
      \end{tikzcd}
    \end{center}
    Since $X$ is formally smooth we merely have an $x:X$ such that:
\[\prod_{p:\epsilon=0} \phi(p)=x\]
and therefore:
\[ \epsilon=0 \to y=f(x)\]
which means that $y\in N_1(f(x))$. 

We use \Cref{duality-infinitesimal-tangent} and \Cref{neighborhood-tangent-correspondence-smooth} to get that the map $N_1(x)\to N_1(f(x))$ induced by $f$ merely has a section $s$ sending $f(x)$ to $x$. Then $s(y):\fib_f(y)$ is such that for all $p:\epsilon=0$ we have that:
\[\phi(p) = x = s(f(x)) = s(y)\]
\end{proof}

\begin{corollary}\label{etale-schemes-iff-local-iso}
Let $f:X\to Y$ be a map between schemes with $X$ smooth. Then the following are equivalent:
\begin{enumerate}[(i)]
\item The map $f$ is étale. 
\item For all $x:X$, the induced map:
\[df : T_x(X)\to T_{f(x)}(Y)\]
is an iso.
\end{enumerate}
\end{corollary}

\begin{proof}
We apply \Cref{unramified-map-characterisation} and \Cref{smooth-schemes-iff-submersion}.
\end{proof}

\begin{remark}\label{smooth-maps-are-submersions}
In both previous results, we did not use the smoothness hypothesis on $X$ to prove (i) implies (ii).
\end{remark}

\subsection{Smooth schemes have free tangent spaces}

\begin{lemma}\label{smooth-implies-smooth-tangent}
Assume $X$ is a smooth scheme. Then for any $x:X$ the type $T_x(X)$ is smooth.
\end{lemma}

\begin{proof}
Consider $T(X) = X^{\mathbb{D}(1)}$ the tangent bundle of $X$. We have to prove that the map:
\[p:T(X)\to X\]
is formally smooth. Both source and target are schemes, and the source is formally smooth because $X$ is smooth and $\mathbb{D}(1)$ has choice. So by \Cref{smooth-schemes-iff-submersion} it is enough to prove that for all $x:X$ and $v:T_x(X)$ the induced map:
\[dp:T_{(x,v)}(T(X))\to T_x(X)\]
is surjective. 

Consider $u:T_x(X)$. By unpacking the definition of tangent spaces and computing $dp(w)$, we see that merely finding $w:T_{(x,v)}(T(X))$ such that $dp(w) = u$ means merely finding:
\[\phi : \mathbb{D}(1) \times \mathbb{D}(1) \to X\]
such that for all $t:\mathbb{D}(1)$ we have that:
\[\phi(0,t) = v(t)\]
\[\phi(t,0) = u(t)\]

But from \Cref{from-D1-to-D2} we know that there exists a unique:
\[\psi_{v,u} : \mathbb{D}(2)\to X\]
such that:
\[\psi_{v,u}(0,t) = v(t)\]
\[\psi_{v,u}(t,0) = u(t)\]

Then since $X$ is smooth and the fibers of:
\[\mathbb{D}(2) \to\mathbb{D}(1) \times \mathbb{D}(1) \]
are closed dense, we conclude from $\mathbb{D}(1) \times \mathbb{D}(1)$ having choice that there merely exists a lift of $\psi_{v,u}$ to $\mathbb{D}(1) \times \mathbb{D}(1)$, which gives us the $\phi$ we wanted.
\end{proof}

\begin{lemma}\label{smooth-kernel-decidable}
Assume given a linear map:
\[M:R^m\to R^n\] 
which has smooth kernel $K$. Then we can decide whether $M=0$.
\end{lemma}

\begin{proof}
Since $M=0$ is closed, by \Cref{not-not-stable-prop-etale} and \Cref{closed-and-etale-decidable} it is enough to prove that it is $\neg\neg$-stable to conclude that it is decidable. Assume $\neg\neg(M=0)$, then for any $x:R^m$ we have a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        M=0\ar[d] \ar[r,"\_\, \mapsto x"] & K \\
       1 \ar[dashed,ru] &
      \end{tikzcd}
\end{center}
because $K$ is formally smooth, so that we merely have $y\in K$ such that: 
\[M=0\to x=y\]
which implies that $\neg\neg(x=y)$ since we assumed $\neg\neg(M=0)$.

Then considering a basis $(x_1,\cdots,x_n)$ of $R^m$, we get $(y_1,\cdots,y_n)$ such that for all $i$ we have that $y_i\in K$ and $\neg\neg(y_i=x_i)$. But then we have that $(y_1,\cdots,y_n)$ is infinitesimally close to a basis and that being a basis is an open proposition, so that $(y_1,\cdots,y_n)$ is a basis and $K=R^m$ so $M=0$.
\end{proof}

\begin{lemma}\label{smooth-corpresented-implies-free}
Assume that $K$ is a finitely copresented module that is also smooth. Then it is finite free.
\end{lemma}

\begin{proof}
Assume a finite copresentation:
\[0\to K\to R^m\overset{M}{\to} R^n\]
We proceed by induction on $m$. By \Cref{smooth-kernel-decidable} we can decide whether $M=0$ or not.
\begin{itemize}
\item If $M=0$ then $K=R^m$ and we can conclude.
\item If $M\not=0$ then we can find a non-zero coefficient in the matrix corresponding to $M$, and so up to base change it is of the form:
\[
\begin{pmatrix}
1 & \begin{matrix}0&\cdots & 0\end{matrix}  \\
\begin{matrix}0\\ \vdots\\ 0\end{matrix} & \widetilde{M} \\
\end{pmatrix}
\]
But then we know that the kernel of $M$ is isomorphic to the kernel of $\widetilde{M}$, and by applying the induction hypothesis we can conclude that it is finite free.
\end{itemize}
\end{proof}

\begin{proposition}\label{smooth-have-free-tangent}
Let $X$ be a smooth scheme. Then for any $x:X$ we have that $T_x(X)$ is finite free.
\end{proposition}

\begin{proof}
By \Cref{smooth-implies-smooth-tangent} we have that $T_x(X)$ is formally smooth, so that we can conclude by \Cref{smooth-corpresented-implies-free}.
\end{proof}

The dimension of $T_x(X)$ is called the dimension of $X$ at $x$. By boundedness any smooth scheme is a finite sum of smooth schemes of a fixed dimension.
We can turn this into a definition of dimension which works well in the case of smooth schemes:

\begin{definition}
  \label{definition-smooth-dim-n}
  A scheme is \notion{smooth of dimension $n$}, if it is smooth and all its tangent spaces are finite free of dimension $n$.
\end{definition}


\subsection{Standard étale and standard smooth schemes}

\begin{definition}
A standard smooth scheme of dimension $k$ is an affine scheme of the form:
\[\Spec\big(R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n\big)\]
where the determinant of:
\[\left( \frac{\partial P_i}{\partial X_j}\right)_{1\leq i,j\leq n}\]
is invertible in $R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n$.
\end{definition}

\begin{definition}
A standard smooth scheme of dimension $0$ is called a \notion{standard étale scheme}.
\end{definition}

\begin{remark}
  \label{standard-open-in-std-smooth}
  Let $X=\Spec\big(R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n\big)$
  be as above but such that the determinant is
  only invertible in a localization $(R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n)_G$ for some $G:X\to R$.
  Then $X$ is standard smooth of dimension $k$ since it is
  \[ \Spec\big(R[X_1,\cdots,X_n,X_{n+1},Y_1,\cdots,Y_k] / P_1,\cdots,P_n,GX_{n+1}-1\big)\]
  and we can compute
  \[\mathrm{det}(\mathrm{Jac}(P_1,\cdots,P_n,GX_{n+1}-1)) = \pm\mathrm{det}(\mathrm{Jac}(P_1,\cdots,P_n)) \cdot G\]
  which is invertible in $R[X_1,\cdots,X_n,X_{n+1},Y_1,\cdots,Y_k] / P_1,\cdots,P_n,GX_{n+1}-1$.
\end{remark}

\begin{lemma}\label{standard-etale-are-etale}
Standard étale schemes are étale.
\end{lemma}

\begin{proof}
Assume given a standard étale algebra:
\[R[X_1,\cdots,X_n]/P_1,\cdots,P_n\]
and write:
\[P:R^n\to R^n\]
for the map induced by $P_1,\cdots,P_n$.

Assume given $\epsilon:R$ such that $\epsilon^2=0$, we need to prove that there is a unique dotted lifting in:
  \begin{center}
      \begin{tikzcd}
       R/\epsilon & R[X_1,\cdots,X_n]/P_1,\cdots,P_n\ar[l,swap,"x"]\ar[dashed,ld] \\
       R\ar[u]&
      \end{tikzcd}
    \end{center}
This means that for all $x:R^n$ such that $P(x)=0$ mod $\epsilon$, there exists a unique $y:R^n$ such that:
\begin{itemize} 
\item We have $x=y$ mod $\epsilon$.
\item We have $P(y)=0$.
\end{itemize}

First we prove existence. For any $b:R^n$ we compute:
\[P(x+\epsilon b) = P(x) + \epsilon\ dP_x(b)\]
We have that $P(x)=0$ mod $\epsilon$, say $P(x) = \epsilon a$. Since $\neg\neg(P(x) = 0)$, we have that $dP_x$ is invertible. Then taking $b = -(dP_x)^{-1}(a)$ gives a lift $y=x+\epsilon b$ such that $P(y) = 0$.

Now we check unicity. Assume $y,y'$ two such lifts, then $y=y'$ mod $\epsilon$ and we have:
\[P(y) = P(y') + dP_{y'}(y-y')\]
and $P(y)=0$ and $P(y')=0$ so that:
\[dP_{y'}(y-y') = 0\]
But $dP_{y'}$ is invertible and we can conclude that $y=y'$.
\end{proof}

\begin{lemma}\label{standard-smooth-is-smooth}
Any standard smooth scheme of dimension $k$ is smooth of dimension $k$. %(\Cref{definition-smooth-dim-n}).
\end{lemma}

\begin{proof}
The fibers of the map:
\[\Spec\big(R[X_1,\cdots,X_n,Y_1,\cdots Y_{k}] / P_1,\cdots,P_n\big) \to \Spec(R[Y_1,\cdots Y_{k}])\]
are standard étale, so the map is étale by \Cref{standard-etale-are-etale}. Since:
\[\Spec(R[Y_1,\cdots Y_{k}]) = \A^k\]
is smooth by \Cref{An-is-smooth}, we can conclude it is smooth using \Cref{smooth-sigma-closed}. 

For the dimension we use \Cref{An-dimension-n} and \Cref{smooth-maps-are-submersions}.
\end{proof}



\subsection{Smooth schemes are locally standard smooth}

\begin{proposition}\label{smooth-are-locally-standard}
A scheme is smooth of dimension $k$ if and only if it has a finite open cover by standard smooth schemes of dimension $k$.
\end{proposition}

\begin{proof}
We can assume the scheme $X$ affine, say of the form:
\[X = \Spec(R[X_1,\cdots,X_m]/P_1,\cdots,P_l)\]

By \Cref{smooth-have-free-tangent}, for any $x:X$ we have that $dP_x$ has finite free kernel of rank $k$. Then by \Cref{rank-equivalent-definitions} we know that $dP_x$ has rank $n=m-k$ for every $x$.

We cover $X$ according to which $n$-minor is invertible, so that up to a rearranging of variables and polynomials and using \Cref{standard-open-in-std-smooth} we can assume that:
\[X = \Spec(R[X_1,\cdots,X_{q},Y_1,\cdots,Y_k]/P_1,\cdots,P_{q},Q_1,\cdots, Q_p)\]
with $q:=n+1$ and where $P_q$ is given by the construction in \Cref{standard-open-in-std-smooth} and we have:
\[d(P,Q)_{x,y} = \begin{pmatrix}
\left(\frac{\partial P}{\partial X}\right)_{x,y} & \left(\frac{\partial P}{\partial Y}\right)_{x,y} \\
\left(\frac{\partial Q}{\partial X}\right)_{x,y} & \left(\frac{\partial Q}{\partial Y}\right)_{x,y} \\
\end{pmatrix}\]
where we used the notation:
\[\left(\frac{\partial P}{\partial X}\right)_{x,y} = \begin{pmatrix}\left(\frac{\partial P_i}{\partial X_j}\right)_{x,y}\end{pmatrix}_{i,j}\]
so that $\frac{\partial P}{\partial X}_{x,y}$ is invertible of size $q$. Moreover by \Cref{rank-bloc-matrix} we get:
\[\left(\frac{\partial Q}{\partial Y}\right)_{x,y} = \left(\frac{\partial Q}{\partial X}\right)_{x,y}\left(\frac{\partial P}{\partial X}\right)_{x,y}^{-1} \left(\frac{\partial P}{\partial Y}\right)_{x,y} \]
which will be useful later.

Now we prove that for any $(x,y):R^{q+k}$ such that $P(x,y)=0$ it is decidable whether
\[Q(x,y)=0 \] 
Using \Cref{square-zero-implies-zero-decidable} this follow from:
\[(Q_1(x,y),\cdots,Q_p(x,y))^2=0 \to (Q_1(x,y),\cdots,Q_p(x,y))=0\]
Assuming $(Q_1(x,y),\cdots,Q_p(x,y))^2=0$, by smoothness there is a dotted lift in:
\begin{center}
      \begin{tikzcd}
        R/(Q_1(x,y),\cdots,Q_l(x,y)) & \Spec(R[X_1,\cdots,X_q,Y_1,\cdots,Y_k]/P_1,\cdots,P_q,Q_1,\cdots, Q_l)\ar[l,swap,"(x{,}y)"] \ar[dotted,ld,"(x{'}{,}y{'})"]\\
       R\ar[u] & \\
      \end{tikzcd}
\end{center}
Let us prove that $Q(x,y) = 0$. Indeed we have $(x,y) \sim_1 (x',y')$ so that we have:
\[P(x,y) = P(x',y')+ \left(\frac{\partial P}{\partial X}\right)_{x',y'}(x-x') + \left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y') \]
\[Q(x,y) = Q(x',y')+ \left(\frac{\partial Q}{\partial X}\right)_{x',y'}(x-x') + \left(\frac{\partial Q}{\partial Y}\right)_{x',y'}(y-y') \]
Then we have $P(x,y) = 0$, $P(x',y')=0$ and $Q(x',y') = 0$. From the first equality we get:
\[x-x' =  -\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1}\left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y')\]
so that from the second we get:
\[Q(x,y) = -\left(\frac{\partial Q}{\partial X}\right)_{x',y'}\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1}\left(\frac{\partial P}{\partial Y}\right)_{x',y'}(y-y') + \left(\frac{\partial Q}{\partial Y}\right)_{x',y'}(y-y')\]
so that $Q(x,y)=0$ as we have seen previously that:
\[\left(\frac{\partial Q}{\partial Y}\right)_{x',y'} = \left(\frac{\partial Q}{\partial X}\right)_{x',y'}\left(\frac{\partial P}{\partial X}\right)_{x',y'}^{-1} \left(\frac{\partial P}{\partial Y}\right)_{x',y'} \]
From the decidability of $Q(x,y)=0$ we get that $X$ is an open in $\Spec(R[X_1,\cdots,X_q,Y_1,\cdots,Y_k]/P_1,\cdots,P_q)$
so it is of the form $D(G_1,\cdots,G_r)$, and we have an open cover of our scheme by pieces of the form:
\[\Spec((R[X_1,\cdots,X_q,Y_1,\cdots,Y_k]/P_1,\cdots,P_q)_{G_i})\]
and we can conclude with \Cref{standard-open-in-std-smooth}.
\end{proof}

\begin{corollary}
A scheme is formally étale if and only if it has a cover by standard étale schemes.
\end{corollary}

\begin{proof}
By \Cref{unramified-scheme-characterisation} we know that a scheme is formally étale if and only if it is smooth of dimension $0$. Then we just apply \Cref{smooth-are-locally-standard}.
\end{proof}

% \begin{remark}
% An affine scheme with a cover by standard étale schemes is itself standard étale. TODO
% \end{remark}
